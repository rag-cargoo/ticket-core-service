# ë™ì‹œì„± ì œì–´ ë° ê³ ì„±ëŠ¥ ëŒ€ê¸°ì—´ ì „ëžµ (Concurrency & Queue Strategy)

> **Purpose**: ì„ ì°©ìˆœ ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ì •í•©ì„± í•´ê²°ë¶€í„° ì´ˆê³ ì† ëŒ€ê¸°ì—´ ì„¤ê³„ê¹Œì§€ì˜ ê¸°ìˆ ì  ì—¬ì •
> **Date**: 2026-02-07

---

## ðŸ“‚ ëª©ì°¨ (Table of Contents)
- ðŸ’¡ [0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½](#0-ì´ë¡ -ë°°ê²½-ë‚™ê´€ì -ë½-vs-ë¹„ê´€ì -ë½-theory)
- ðŸš€ [Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)](#step-0-ë¬¸ì œ-ìƒí™©-ë½-ë¯¸ì ìš©)
- ðŸš€ [Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)](#step-1-ë‚™ê´€ì -ë½-optimistic-lock)
- ðŸš€ [Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)](#step-2-ë¹„ê´€ì -ë½-pessimistic-lock)
- âš ï¸ [ë½(Lock)ì˜ í•œê³„ì™€ í˜„ì‹¤ì ì¸ ë¬¸ì œ](#-ë½lockì˜-í•œê³„ì™€-í˜„ì‹¤ì ì¸-ë¬¸ì œ)
- ðŸš€ [Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)](#step-3-redis-ë¶„ì‚°-ë½-distributed-lock)
- ðŸš€ [Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue)](#step-4-kafka-ê¸°ë°˜-ë¹„ë™ê¸°-ëŒ€ê¸°ì—´-async-queue)
- ðŸš€ [Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´](#step-5-redis-sorted-set-ê¸°ë°˜-ì‹¤ì‹œê°„-ëŒ€ê¸°ì—´)
- ðŸš€ [Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling)](#step-6-ìœ ìž…ëŸ‰-ì œì–´-ì „ëžµ-throttling)

---

## 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½ (Theory)
---
> | íŠ¹ì§• | ë‚™ê´€ì  ë½ (Optimistic Lock) | ë¹„ê´€ì  ë½ (Pessimistic Lock) |
> | :--- | :--- | :--- |
> | **ê¸°ë³¸ ì‚¬ìƒ** | "ì¶©ëŒì€ ë“œë¬¼ ê±°ì•¼. ì¶©ëŒ ë‚˜ë©´ ê·¸ë•Œ í•´ê²°í•˜ìž." | "ì¶©ëŒì€ ë¹ˆë²ˆí•  ê±°ì•¼. ì•„ì˜ˆ ëª» ê±´ë“œë¦¬ê²Œ ë§‰ìž." |
> | **êµ¬í˜„ ë°©ì‹** | **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§**: ë²„ì „ ì»¬ëŸ¼(@Version) ë¹„êµ. | **DB ì¿¼ë¦¬**: SELECT ... FOR UPDATEë¡œ ë¬¼ë¦¬ì  ë½. |
> | **ì„±ëŠ¥ (DB)** | **ë†’ìŒ** (ë½ ëŒ€ê¸° ì—†ìŒ) | **ë‚®ìŒ** (ëŒ€ê¸° ë°œìƒ, ë°ë“œë½ ìœ„í—˜) |
> | **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ (Exception) -> ë¡¤ë°± -> ìž¬ì‹œë„ í•„ìš” | ëŒ€ê¸° (Wait) -> ìˆœì°¨ ì²˜ë¦¬ -> ì„±ê³µ |
> | **ëŒ€í‘œ ì˜ˆì‹œ** | ê²Œì‹œíŒ ìˆ˜ì •, í”„ë¡œí•„ ì—…ë°ì´íŠ¸ | ì„ ì°©ìˆœ ì˜ˆë§¤, ìž¬ê³  ì°¨ê°, ê³„ì¢Œ ì´ì²´ |

---

## Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)
---
> ### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> ---
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_1_ë‚™ê´€ì _ë½.java` (JPA @Version ì£¼ì„ ì²˜ë¦¬ í›„ ì‹¤í–‰)
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
>
> ### 2. ìž˜ëª»ëœ êµ¬í˜„ ë°©ì‹ (The Wrong Way)
> ---
> - ì•„ë¬´ëŸ° ë³´í˜¸ ìž¥ì¹˜ ì—†ì´ ì¼ë°˜ì ì¸ ì¡°íšŒì™€ ìˆ˜ì •ì„ ë°˜ë³µí•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.
> ```java
> @Transactional
> public void reserve(Long seatId) {
>     Seat seat = seatRepository.findById(seatId).orElseThrow();
>     seat.reserve();
> }
> ```
>
> ### 3. ì‹¤í—˜ ê²°ê³¼ (ì‹¤íŒ¨)
> ---
> - ë°ì´í„° ì •í•©ì„±ì´ ì™„ì „ížˆ ê¹¨ì§€ëŠ” í˜„ìƒì´ ë°œìƒí•¨. (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)
> - **ì„±ê³µ íšŸìˆ˜**: 10ê±´ (ì¹˜ëª…ì  ì˜¤ë¥˜)
> - **ìµœì¢… ì˜ˆì•½ ê±´ìˆ˜**: 10ê±´ (Race Condition ë°œìƒ)

---

## Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)
---
> ### 1. êµ¬í˜„ ë°©ë²• (How to Apply)
> ---
> - ì—”í‹°í‹°ì— @Version ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì˜ ì²´í¬ ë¡œì§ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
> ```java
> @Version 
> private Long version;
> ```
>
> ### 2. ë™ìž‘ ì›ë¦¬ ë° SQL
> ---
> - ìˆ˜ì • ì¿¼ë¦¬ ì‹œì ì— ìžë™ìœ¼ë¡œ ë²„ì „ ì²´í¬ ì¡°ê±´ì´ ë¶™ìŠµë‹ˆë‹¤.
> ```sql
> update seats set status='RESERVED', version=1 where id=1 and version=0;
> ```
>
> ### 3. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
> ---
> - **ì„±ê³µ íšŸìˆ˜**: 1ê±´
> - **ì‹¤íŒ¨ íšŸìˆ˜**: 29ê±´ (ObjectOptimisticLockingFailureException ë°œìƒ)
> - **ê²°ë¡ **: ë°ì´í„° ì •í•©ì„±ì€ ë³´ìž¥í•˜ë‚˜, ì¶©ëŒ ì‹œ ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ ì„ ì°©ìˆœ ì˜ˆë§¤ì—ëŠ” í•œê³„ê°€ ìžˆìŒ.

---

## Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)
---
> ### 1. êµ¬í˜„ ë°©ë²• (How to Apply)
> ---
> - Spring Data JPAì—ì„œ ë¹„ê´€ì  ë½ì„ ê±°ëŠ” ë°©ë²• ì¤‘ @Lock ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©ì„ ê¶Œìž¥í•©ë‹ˆë‹¤.
> ```java
> public interface SeatRepository extends JpaRepository<Seat, Long> {
>     @Lock(LockModeType.PESSIMISTIC_WRITE)
>     @Query("SELECT s FROM Seat s WHERE s.id = :id")
>     Optional<Seat> findByIdWithPessimisticLock(@Param("id") Long id);
> }
> ```
>
> ### 2. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
> ---
> - **ìž¥ì **: ê°•ë ¥í•œ ì •í•©ì„± ë³´ìž¥, ë³„ë„ ìž¬ì‹œë„ ë¡œì§ ë¶ˆí•„ìš”.
> - **ë‹¨ì **: ëŒ€ê¸° ì‹œê°„ì´ ê¸¸ì–´ì§€ë©´ DB ì»¤ë„¥ì…˜ í’€ ë§ˆë¹„ ìœ„í—˜.

---

## ðŸš¨ ë½(Lock)ë§Œìœ¼ë¡œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” í˜„ì‹¤ì ì¸ ë¬¸ì œ
---
> ### 1. ì‚¬ìš©ìž ê²½í—˜(UX)ì˜ íŒŒê´´
> ---
> - í˜„ìž¬ ë°©ì‹ì€ 1ëª…ì´ ë½ì„ ìž¡ê³  ìžˆëŠ” ë™ì•ˆ ë‚˜ë¨¸ì§€ëŠ” ëŒ€ê¸°í•˜ê±°ë‚˜ ì—ëŸ¬ë¥¼ ë°›ëŠ”ë‹¤. 1ë§Œ ëª… ì¤‘ 9,999ëª…ì€ ë¬´ì¡°ê±´ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë³´ê²Œ ë¨.
>
> ### 2. ì„œë²„ ìžì› ê³ ê°ˆ
> ---
> - ë¹„ê´€ì  ë½(FOR UPDATE)ì€ DB ì»¤ë„¥ì…˜ì„ ì ìœ í•œ ì±„ë¡œ ëŒ€ê¸°í•˜ì—¬ ì „ì²´ ì„œë²„ ë§ˆë¹„ ìƒíƒœ(Cascading Failure)ë¥¼ ìœ ë°œ.
>
> ### ðŸ’¡ í•´ê²° ë°©í–¥: Redis ë¶„ì‚° ë½ê³¼ ëŒ€ê¸°ì—´
> ---
> - **ì²´ë ¥ ê°•í™”**: ì´ˆê³ ì† Redisì—ì„œ ë½ì„ ì²˜ë¦¬í•˜ì—¬ DB ë¶€í•˜ ì›ì²œ ì°¨ë‹¨.
> - **ì§ˆì„œ í™•ë¦½**: ì‹¤íŒ¨ê°€ ì•„ë‹Œ ëŒ€ê¸°ì—´(Queue)ì„ ë„ìž…í•˜ì—¬ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” UX ì œê³µ.

---

## Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)
---
> ### ðŸ§ª Step 3-1: ì²« ë²ˆì§¸ ì‹œë„ (ì‹¤íŒ¨ ì‚¬ë¡€) âŒ
> ---
> - **ì‹¤í—˜ ê²°ê³¼**: 30ëª… ì „ì› ì˜ˆì•½ ì„±ê³µ (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)
> - **ì›ì¸ ë¶„ì„**: ë½ í•´ì œ ì‹œì ì´ íŠ¸ëžœìž­ì…˜ ì»¤ë°‹ë³´ë‹¤ ë¹¨ë¼ ì •í•©ì„± íŒŒê´´.
>
> ### âœ… Step 3-2: ë‘ ë²ˆì§¸ ì‹œë„ (ì„±ê³µ ì‚¬ë¡€ - Facade ë„ìž…)
> ---
> - **í•´ê²° ì „ëžµ**: RedissonLockFacadeë¥¼ ë„ìž…í•˜ì—¬ DB ì»¤ë°‹ì´ ì™„ë²½ížˆ ëë‚œ ë’¤ì— ë½ì„ í’€ë„ë¡ ì œì–´.
>
> ### ðŸŒŸ Magic Numberë¥¼ ë°°ì œí•œ ìžìœ¨ì  ì„¤ê³„ (ì¤‘ìš”)
> ---
> - **ì§ìž‘í•˜ëŠ” ìˆ«ìžì˜ ìœ„í—˜ì„±**: `lock.tryLock(10, 2, ...)`ì—ì„œ `2ì´ˆ`ëŠ” ê°œë°œìžì˜ ì§ìž‘ì¼ ë¿, DB ë¶€í•˜ ì‹œ ì •í•©ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìžˆìŒ.
> - **ìžìœ¨ì  í•´ê²°ì±…: Redisson Watchdog ðŸ•**: leaseTimeì„ -1ë¡œ ì„¤ì •í•˜ì—¬ ì‹œìŠ¤í…œì´ ìŠ¤ìŠ¤ë¡œ ë½ ì‹œê°„ì„ ì—°ìž¥í•˜ê²Œ í•¨. "ìƒí™©ì„ ë‹¨ì • ì§“ì§€ ë§ê³ , ì‹œìŠ¤í…œì´ íë¥´ê²Œ í•˜ë¼."
> ```java
> boolean available = lock.tryLock(10, -1, TimeUnit.SECONDS);
> ```

---

## Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue) âœ…
---
> ### ðŸ’¡ 1. íŒ¨ëŸ¬ë‹¤ìž„ì˜ ì „í™˜
> ---
> - "í•œ ë†ˆë§Œ ë“¤ì–´ì™€"ì—ì„œ "ëª¨ë‘ ì¤„ì„ ì„œì„¸ìš”"ë¡œ ì „í™˜í•˜ì—¬ ì„œë²„ ë¶€í•˜ ë¶„ì‚°.
>
> ### ðŸ› ï¸ 2. í•µì‹¬ êµ¬í˜„ ë§¤ì»¤ë‹ˆì¦˜
> ---
> - **Producer**: seatIdë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ìˆœì„œ ë³´ìž¥ ì „ì†¡.
> - **Consumer**: ì„œë²„ ìš©ëŸ‰ì— ë§žì¶° ë©”ì‹œì§€ë¥¼ êº¼ë‚´ì–´ ìˆœì°¨ ì²˜ë¦¬.
> - **Notification**: SSEë¥¼ í†µí•´ ì‚¬ìš©ìžì—ê²Œ ì²˜ë¦¬ ê²°ê³¼ ì‹¤ì‹œê°„ í†µë³´.
>
> ### ðŸ“Š 3. í•µì‹¬ ì„¤ê³„ ê²°ì • (ADR)
> ---
> | ê²°ì • ì‚¬í•­ | ì„¤ê³„ ë‚´ìš© | ê³µí•™ì  ì´ìœ  |
> | :--- | :--- | :--- |
> | Partition Key | `seatId` | ë™ì¼ ì¢Œì„ ê²½í•©ì„ ë‹¨ì¼ ìŠ¤ë ˆë“œì—ì„œ ìˆœì°¨ ì²˜ë¦¬ ë³´ìž¥ |
> | Status Store | Redis | ë¹„ë™ê¸° ì²˜ë¦¬ ì¤‘ ì‹¤ì‹œê°„ ìƒíƒœ ì¡°íšŒë¥¼ ìœ„í•œ ì´ˆê³ ì† ì €ìž¥ì†Œ |

---

## Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ âœ…
---
> [!NOTE]
> **í•µì‹¬ ê°€ì¹˜**: ì‚¬ìš©ìžì—ê²Œ "ë‚´ ì•žì˜ ëŒ€ê¸°ìž ìˆ˜"ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í”¼ë“œë°±í•˜ì—¬ UXë¥¼ í˜ì‹ í•©ë‹ˆë‹¤.
>
> ### ðŸ’¡ 1. í•µì‹¬ ë§¤ì»¤ë‹ˆì¦˜: ZSET (Sorted Set)
> ---
> - **Key**: `waiting-queue:concert:{id}`
> - **Score**: `System.currentTimeMillis()` (ì‹œê°„ìˆœ ìžë™ ì •ë ¬)
> - **ìž¥ì **: 100ë§Œ ëª… ì¤‘ ë‚´ ìˆœìœ„ë¥¼ $O(\log N)$ì˜ ì´ˆê³ ì† ì„±ëŠ¥ìœ¼ë¡œ ì¡°íšŒ ê°€ëŠ¥.
>
> ### ðŸ› ï¸ 2. ì‹¤ì œ êµ¬í˜„ ì½”ë“œ (WaitingQueueServiceImpl)
> ---
> ```java
> @Override
> public WaitingQueueResponse join(Long userId, Long concertId) {
>     String queueKey = QUEUE_KEY_PREFIX + concertId;
>     String userIdStr = String.valueOf(userId);
>     // í™œì„± ìƒíƒœ í™•ì¸ ë° ëŒ€ê¸°ì—´ ì§„ìž…
>     if (Boolean.TRUE.equals(redisTemplate.hasKey(ACTIVE_KEY_PREFIX + userIdStr))) {
>         return WaitingQueueResponse.builder().userId(userId).concertId(concertId).status("ACTIVE").rank(0L).build();
>     }
>     redisTemplate.opsForZSet().add(queueKey, userIdStr, System.currentTimeMillis());
>     return getStatus(userId, concertId);
> }
> ```
>
> ### ðŸ§ª 3. ê²€ì¦ ê²°ê³¼ ë° íš¨ê³¼ (Results & Impact)
> ---
> - **í…ŒìŠ¤íŠ¸ ë¡œê·¸**: `[User 101] WAITING (Rank: 1)`, `[User 102] WAITING (Rank: 2)`
> - **ë¹„í¬/ì• í”„í„°**: ë¬´í•œ ëŒ€ê¸°(Step 4) -> ì‹¤ì‹œê°„ ìˆœë²ˆ í”¼ë“œë°±(Step 5).
> - **íš¨ê³¼**: UX ê°œì„  ë° ë¶ˆí•„ìš”í•œ ìƒˆë¡œê³ ì¹¨ ìž¬ìš”ì²­ ì°¨ë‹¨.

---

## Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling) ðŸ‘ˆ
---
> [!WARNING]
> **ì‹œìŠ¤í…œ ìƒì¡´ ë³´ìž¥**: ìž„ê³„ì¹˜ ì´ìƒì˜ ìš”ì²­ì„ ì‚¬ì „ì— ì°¨ë‹¨í•˜ê³  í™œì„±í™” ì¸ì›ì„ ë™ì ìœ¼ë¡œ ì¡°ì ˆí•˜ëŠ” ìµœì¢… ìˆ˜ë¹„ ë‹¨ê³„ìž…ë‹ˆë‹¤.
>
> ### ðŸ› ï¸ 1. í•µì‹¬ ì œì–´ ë§¤ì»¤ë‹ˆì¦˜
> ---
> - **ì§„ìž… ì°¨ë‹¨ (Throttling)**: ZCARDë¡œ í˜„ìž¬ ëŒ€ê¸° ì¸ì› ì²´í¬, ìž„ê³„ì¹˜(ì˜ˆ: 50,000) ì´ˆê³¼ ì‹œ ì§„ìž… ê±°ë¶€.
> - **ìœ ìž…ëŸ‰ ì¡°ì ˆ**: ì„œë²„ ìƒíƒœì— ë”°ë¼ ê°€ë³€ ë°°ì¹­(Dynamic Batching) ì ìš©.
> - **ë³´ì•ˆ**: `ActiveUserInterceptor`ë¥¼ í†µí•œ ì–´ë·°ì§• ì›ì²œ ì°¨ë‹¨.
>
> ### ðŸ”„ 2. ìƒíƒœ ì „ì´ë„ (State Transition)
> ---
> - `WAITING (ZSET)` -> `CHECK_THROTTLE` -> `ACTIVE (String + TTL)` -> `RESERVING (API í˜¸ì¶œ)`