# ë™ì‹œì„± ì œì–´ ì „ëžµ (Concurrency Control Strategy)

> **Purpose**: ì„ ì°©ìˆœ ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œì—ì„œ ë°œìƒí•˜ëŠ” ë°ì´í„° ì •í•©ì„± ë¬¸ì œ í•´ê²° ë° ì„±ëŠ¥ ìµœì í™” ì „ëžµ ê¸°ë¡
> **Date**: 2026-02-05

## 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½ (Theory)
---
>
> | íŠ¹ì§• | ë‚™ê´€ì  ë½ (Optimistic Lock) | ë¹„ê´€ì  ë½ (Pessimistic Lock) |
> | :--- | :--- | :--- |
> | **ê¸°ë³¸ ì‚¬ìƒ** | "ì¶©ëŒì€ ë“œë¬¼ ê±°ì•¼. ì¶©ëŒ ë‚˜ë©´ ê·¸ë•Œ í•´ê²°í•˜ìž." | "ì¶©ëŒì€ ë¹ˆë²ˆí•  ê±°ì•¼. ì•„ì˜ˆ ëª» ê±´ë“œë¦¬ê²Œ ë§‰ìž." |
> | **êµ¬í˜„ ë°©ì‹** | **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§**: ë²„ì „ ì»¬ëŸ¼(`@Version`) ë¹„êµ. | **DB ì¿¼ë¦¬**: `SELECT ... FOR UPDATE`ë¡œ ë¬¼ë¦¬ì  ë½. |
> | **ì„±ëŠ¥ (DB)** | **ë†’ìŒ** (ë½ ëŒ€ê¸° ì—†ìŒ) | **ë‚®ìŒ** (ëŒ€ê¸° ë°œìƒ, ë°ë“œë½ ìœ„í—˜) |
> | **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ (`Exception`) -> ë¡¤ë°± -> ìž¬ì‹œë„ í•„ìš” | ëŒ€ê¸° (`Wait`) -> ìˆœì°¨ ì²˜ë¦¬ -> ì„±ê³µ |
> | **ëŒ€í‘œ ì˜ˆì‹œ** | ê²Œì‹œíŒ ìˆ˜ì •, í”„ë¡œí•„ ì—…ë°ì´íŠ¸ | ì„ ì°©ìˆœ ì˜ˆë§¤, ìž¬ê³  ì°¨ê°, ê³„ì¢Œ ì´ì²´ |
>
## ðŸ“‹ ì‹¤í—˜ ê¸°ë¡ ìˆœì„œ (Progress)
1. [Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)](#step-0-ë¬¸ì œ-ìƒí™©-ë½-ë¯¸ì ìš©)
2. [Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)](#step-1-ë‚™ê´€ì -ë½-optimistic-lock)
3. [Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)](#step-2-ë¹„ê´€ì -ë½-pessimistic-lock)
4. [Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)](#step-3-redis-ë¶„ì‚°-ë½-distributed-lock)
5. [Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue)](#step-4-kafka-ê¸°ë°˜-ë¹„ë™ê¸°-ëŒ€ê¸°ì—´-async-queue)
6. [Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´](#step-5-redis-sorted-set-ê¸°ë°˜-ì‹¤ì‹œê°„-ëŒ€ê¸°ì—´)
7. [Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling)](#step-6-ìœ ìž…ëŸ‰-ì œì–´-ì „ëžµ-throttling)

---

## Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)
---
> ### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
> 
> ### 2. ìž˜ëª»ëœ êµ¬í˜„ ë°©ì‹ (The Wrong Way)
> ì•„ë¬´ëŸ° ë³´í˜¸ ìž¥ì¹˜ ì—†ì´ ì¼ë°˜ì ì¸ ì¡°íšŒì™€ ìˆ˜ì •ì„ ë°˜ë³µí•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.
>
> ```java
> // [Service]
> @Transactional
> public void reserve(Long seatId) {
>     Seat seat = seatRepository.findById(seatId).orElseThrow(); // ëˆ„êµ¬ë‚˜ ë™ì‹œì— ì¡°íšŒ ê°€ëŠ¥
>     seat.reserve(); // ê°ìž ë©”ëª¨ë¦¬ ìƒì—ì„œ ìƒíƒœ ë³€ê²½
>     // ì»¤ë°‹ ì‹œì ì— ë§ˆì§€ë§‰ì— ë“¤ì–´ì˜¨ ìš”ì²­ì´ ë®ì–´ì“°ê±°ë‚˜ ì¤‘ë³µ ìƒì„±ë¨ (Race Condition)
> }
> ```
>
### 3. ì‹¤í—˜ ê²°ê³¼ (ì‹¤íŒ¨)
> ë°ì´í„° ì •í•©ì„±ì´ ì™„ì „ížˆ ê¹¨ì§€ëŠ” í˜„ìƒì´ ë°œìƒí•¨. (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)
>
#### [ìˆ˜ì¹˜ ê²°ê³¼]
> | í•­ëª© | ê²°ê³¼ê°’ | ë¹„ê³  |
> | :--- | :--- | :--- |
> | **ì„±ê³µ íšŸìˆ˜** | 10ê±´ | **ì¹˜ëª…ì  ì˜¤ë¥˜**: 1ê±´ì´ì–´ì•¼ í•¨ |
> | **ìµœì¢… ì˜ˆì•½ ê±´ìˆ˜** | **10ê±´** | **ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ (Race Condition)** |
>
---
>
## Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)
---
>
### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_1_ë‚™ê´€ì _ë½.java`
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
>
### 2. êµ¬í˜„ ë°©ë²• (How to Apply)
> ì—”í‹°í‹°ì— `@Version` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì˜ ì²´í¬ ë¡œì§ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
>
> ```java
> // [Entity]
> @Version // JPAê°€ ì œê³µí•˜ëŠ” ë‚™ê´€ì  ë½ ë©”ì»¤ë‹ˆì¦˜
> private Long version;
> ```
>
### 3. ë™ìž‘ ì›ë¦¬ ë° SQL
> ìˆ˜ì • ì¿¼ë¦¬ ì‹œì ì— ìžë™ìœ¼ë¡œ ë²„ì „ ì²´í¬ ì¡°ê±´ì´ ë¶™ìŠµë‹ˆë‹¤.
> ```sql
> update seats 
> set status='RESERVED', version=1 
> where id=1 and version=0; -- ì²˜ìŒ ì½ì€ ë²„ì „ì´ 0ì¼ ë•Œë§Œ ì„±ê³µ
> ```
>
### 4. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
> *   **ì„±ê³µ íšŸìˆ˜**: 1ê±´
> *   **ì‹¤íŒ¨ íšŸìˆ˜**: 29ê±´ (ObjectOptimisticLockingFailureException ë°œìƒ)
> *   **ê²°ë¡ **: ë°ì´í„° ì •í•©ì„±ì€ ë³´ìž¥í•˜ë‚˜, ì¶©ëŒ ì‹œ ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ ì„ ì°©ìˆœ ì˜ˆë§¤ì—ëŠ” í•œê³„ê°€ ìžˆìŒ.
>
---
>
## Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)
---
>
### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_2_ë¹„ê´€ì _ë½.java`
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
>
### 2. êµ¬í˜„ ë°©ë²• (How to Apply)
> Spring Data JPAì—ì„œ ë¹„ê´€ì  ë½ì„ ê±°ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ê°€ ìžˆìŠµë‹ˆë‹¤.
>
#### ë°©ë²• A: @Lock ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš© (ê¶Œìž¥)
> JPAê°€ ì œê³µí•˜ëŠ” `@Lock` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ ìƒì„± ì‹œì ì— ë½ ëª¨ë“œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì„ ì“°ë©´ JPAê°€ SQL ëì— ìžë™ìœ¼ë¡œ `FOR UPDATE`ë¥¼ ì¶”ê°€í•´ ì¤ë‹ˆë‹¤.
>
> ```java
> // [Repository]
> public interface SeatRepository extends JpaRepository<Seat, Long> {
>
>     @Lock(LockModeType.PESSIMISTIC_WRITE) // í•µì‹¬: ë¹„ê´€ì  ë½ ëª¨ë“œ ì§€ì •
>     @Query("SELECT s FROM Seat s WHERE s.id = :id")
>     Optional<Seat> findByIdWithPessimisticLock(@Param("id") Long id);
> }
> ```
>
#### ë°©ë²• B: ì¿¼ë¦¬ì— ì§ì ‘ ëª…ì‹œ
> ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , SQL ë˜ëŠ” JPQL ëì— ì§ì ‘ ë½ í‚¤ì›Œë“œë¥¼ ìž‘ì„±í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ JPA í™˜ê²½ì—ì„œëŠ” ì¼ê´€ì„±ì„ ìœ„í•´ `@Lock` ì‚¬ìš©ì„ ê¶Œìž¥í•©ë‹ˆë‹¤.
>
### 3. ë™ìž‘ ì›ë¦¬ ë° SQL
> ë°ì´í„°ë¥¼ ì½ëŠ” ì‹œì ë¶€í„° DBê°€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì˜ ì ‘ê·¼ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
> ```sql
> /* ë°©ë²• A ì ìš© ì‹œ ì‹¤í–‰ë˜ëŠ” ì‹¤ì œ SQL */
> select s1_0.id, ... 
> from seats s1_0 
> where s1_0.id=? 
> for update; -- DB ì—”ì§„ì´ í•´ë‹¹ í–‰(Row)ì„ ê½‰ ìž¡ìŒ (ìžë¬¼ì‡ )
> ```
>
### 4. ê²°ë¡  (Conclusion)
> *   **ë¹„ê´€ì  ë½ì€ ì¿¼ë¦¬ë¡œ í•´ê²°í•œë‹¤**: ì½”ë“œ ë¡œì§ì´ ì•„ë‹ˆë¼ DB ì—”ì§„ì˜ íž˜ì„ ë¹Œë ¤ **ì¤„ì„ ì„¸ìš°ëŠ” ë°©ì‹**ì´ë‹¤.
> *   **ìž¥ì **: ë‚™ê´€ì  ë½ë³´ë‹¤ ì •í•©ì„±ì´ ê°•ë ¥í•˜ê³ , ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ìž¬ì‹œë„ ë¡œì§ì´ í•„ìš” ì—†ë‹¤.
> *   **ë‹¨ì **: ëŒ€ê¸° ì‹œê°„ì´ ê¸¸ì–´ì§€ë©´ DB ì „ì²´ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤€ë‹¤.
>
---
>
## ðŸš¨ ë½(Lock)ë§Œìœ¼ë¡œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” í˜„ì‹¤ì ì¸ ë¬¸ì œ
>
> ë‚™ê´€ì  ë½ê³¼ ë¹„ê´€ì  ë½ì„ í†µí•´ ë°ì´í„° ì •í•©ì„±ì€ í™•ë³´í–ˆìœ¼ë‚˜, ëŒ€ê·œëª¨ íŠ¸ëž˜í”½(ì˜ˆ: 10,000ëª… ë™ì‹œ ì ‘ì†) ìƒí™©ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ **ì¹˜ëª…ì ì¸ í•œê³„**ê°€ ë°œìƒí•œë‹¤.
>
### 1. ì‚¬ìš©ìž ê²½í—˜(UX)ì˜ íŒŒê´´: "ë§Œ ëª… ì¤‘ í•œ ëª…ë§Œ ì„±ê³µ"
> - í˜„ìž¬ ë°©ì‹ì€ 1ëª…ì´ ë½ì„ ìž¡ê³  ìžˆëŠ” ë™ì•ˆ ë‚˜ë¨¸ì§€ëŠ” ëŒ€ê¸°í•˜ê±°ë‚˜ ì—ëŸ¬ë¥¼ ë°›ëŠ”ë‹¤.
> - ë§Œ ëª…ì˜ ì‚¬ìš©ìž ì¤‘ 9,999ëª…ì€ "ì´ë¯¸ ì˜ˆì•½ëœ ì¢Œì„ìž…ë‹ˆë‹¤"ë¼ëŠ” ë¬´ëšëší•œ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë°›ê³  ë‹¤ì‹œ ê´‘í´ì„ ì‹œë„í•´ì•¼ í•œë‹¤. (ê´‘í´ ì „ìŸ ìœ ë°œ)
>
### 2. ì„œë²„ ìžì› ê³ ê°ˆ: "DB ì»¤ë„¥ì…˜ í’€ ë§ˆë¹„"
> - ë¹„ê´€ì  ë½(`FOR UPDATE`)ì€ DB ì»¤ë„¥ì…˜ì„ ì ìœ í•œ ì±„ë¡œ ëŒ€ê¸°í•œë‹¤.
> - ë™ì‹œ ìš”ì²­ì´ ë§Žì•„ì§€ë©´ ëª¨ë“  ì»¤ë„¥ì…˜ì´ ë½ ëŒ€ê¸°ì— ë¹ ì§€ê²Œ ë˜ì–´, ì˜ˆì•½ê³¼ ìƒê´€ì—†ëŠ” ë‹¤ë¥¸ API(ê³µì—° ì¡°íšŒ ë“±)ê¹Œì§€ ëª¨ë‘ ë¨¹í†µì´ ë˜ëŠ” **'ì„œë²„ ë§ˆë¹„'** ìƒíƒœì— ì´ë¥¸ë‹¤.
>
### ðŸ’¡ í•´ê²°ì˜ ë°©í–¥: Redis ë¶„ì‚° ë½ê³¼ ëŒ€ê¸°ì—´
> - **ì²´ë ¥ ê°•í™” (Step 3)**: DBë³´ë‹¤ í›¨ì”¬ ê°€ë³ê³  ë¹ ë¥¸ **Redis**ì—ì„œ ë½ì„ ì²˜ë¦¬í•˜ì—¬ DB ë¶€í•˜ë¥¼ ì›ì²œ ì°¨ë‹¨í•œë‹¤.
> - **ì§ˆì„œ í™•ë¦½ (Phase 3)**: ë‹¨ìˆœížˆ ì‹¤íŒ¨ì‹œí‚¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ëŒ€ê¸°ì—´(Queue)**ì„ ë„ìž…í•˜ì—¬ ì‚¬ìš©ìžì—ê²Œ ëŒ€ê¸° ìˆœë²ˆì„ ë¶€ì—¬í•˜ê³  ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” UXë¥¼ ì œê³µí•œë‹¤.
>
---
>
## Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)
---
>
### Step 3-1: ì²« ë²ˆì§¸ ì‹œë„ (ì‹¤íŒ¨ ì‚¬ë¡€ - 30/30 ì„±ê³µ) âŒ
>
#### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_3_ë¶„ì‚°_ë½.java`
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
> - **ê²°ê³¼**: **30ëª… ì „ì› ì˜ˆì•½ ì„±ê³µ (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)**
>
#### 2. ì›ì¸ ë¶„ì„ (The Mystery of 30 Successes)
> Redis ë½ì„ íšë“í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³  ì™œ ì •í•©ì„±ì´ ê¹¨ì¡Œì„ê¹Œ? ì—¬ê¸°ì—ëŠ” ë‘ ê°€ì§€ ì¹˜ëª…ì ì¸ í•¨ì •ì´ ìžˆì—ˆë‹¤.
>
> **í•¨ì • 1: ë½ í•´ì œ ì‹œì  vs íŠ¸ëžœìž­ì…˜ ì»¤ë°‹ ì‹œì **
> - **ë¬¸ì œ**: Redis ë½ì€ ë¡œì§ì´ ëë‚˜ìžë§ˆìž `finally` ë¸”ë¡ì—ì„œ í•´ì œëœë‹¤. í•˜ì§€ë§Œ `@Transactional`ì— ì˜í•œ DB ì»¤ë°‹ì€ ê·¸ ì´í›„ì— ë°œìƒí•œë‹¤.
> - **í˜„ìƒ**: Thread Aê°€ ë½ì„ í•´ì œí•˜ëŠ” ìˆœê°„, ì•„ì§ DBì—ëŠ” ë°ì´í„°ê°€ ë°˜ì˜(Commit)ë˜ì§€ ì•Šì•˜ë‹¤. ì´ë•Œ ëŒ€ê¸°í•˜ë˜ Thread Bê°€ ì¦‰ì‹œ ë½ì„ ìž¡ê³  ì§„ìž…í•˜ë©´, BëŠ” ì—¬ì „ížˆ `AVAILABLE` ìƒíƒœì˜ ë°ì´í„°ë¥¼ ì½ê²Œ ëœë‹¤.
>
> **í•¨ì • 2: ìŠ¤í”„ë§ í”„ë¡ì‹œì˜ í•œê³„ (Internal Call)**
> - **ë¬¸ì œ**: `createReservationWithDistributedLock` ë‚´ë¶€ì—ì„œ `this.createReservation()`ì„ í˜¸ì¶œí•˜ë©´, ìŠ¤í”„ë§ì˜ AOP í”„ë¡ì‹œê°€ ìž‘ë™í•˜ì§€ ì•Šì•„ `@Transactional`ì´ ë¬´ì‹œëœë‹¤.
> - **í˜„ìƒ**: ê° DB ìž‘ì—…ì´ ê°œë³„ íŠ¸ëžœìž­ì…˜ìœ¼ë¡œ ëŒê±°ë‚˜ ì»¤ë°‹ ì‹œì ì´ ëª¨í˜¸í•´ì ¸ì„œ ë½ì˜ ë³´í˜¸ë¥¼ ì „í˜€ ë°›ì§€ ëª»í•˜ê²Œ ëœë‹¤.
>
#### 3. êµí›ˆ (Lesson Learned)
> > **"ë¶„ì‚° ë½ì˜ í•´ì œ ì‹œì ì€ ë°˜ë“œì‹œ íŠ¸ëžœìž­ì…˜ì˜ ì»¤ë°‹ ì‹œì ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•œë‹¤."**
> > ë˜í•œ, íŠ¸ëžœìž­ì…˜ ì „íŒŒë¥¼ ìœ„í•´ ë³„ë„ì˜ Facade í´ëž˜ìŠ¤ë¥¼ ë‘ê±°ë‚˜ ìŠ¤í”„ë§ ë¹ˆì˜ ì™¸ë¶€ í˜¸ì¶œì„ ì´ìš©í•´ì•¼ í•œë‹¤.
>
---
>
### Step 3-2: ë‘ ë²ˆì§¸ ì‹œë„ (ì„±ê³µ ì‚¬ë¡€ - Facade íŒ¨í„´ ë„ìž…) âœ…
>
#### 1. Facade(íŒŒì‚¬ë“œ) íŒ¨í„´ì´ëž€?
> 'ê±´ë¬¼ì˜ ì •ë©´'ì´ë¼ëŠ” ëœ»ìœ¼ë¡œ, ë‚´ë¶€ì˜ ë³µìž¡í•œ ë¡œì§ë“¤ì„ í•˜ë‚˜ì˜ ê²‰ê»ë°ê¸° í´ëž˜ìŠ¤ë¡œ ê°ì‹¸ì„œ ë°–ì—ì„œëŠ” ë‹¨ìˆœí•˜ê²Œ ë³´ì´ê²Œ ë§Œë“œëŠ” ë””ìžì¸ íŒ¨í„´ì´ë‹¤.
>
#### 2. ì™œ Facadeê°€ í•„ìš”í•œê°€? (íŠ¸ëžœìž­ì…˜ì˜ í•¨ì •)
> ìŠ¤í”„ë§ì˜ `@Transactional`ì€ ë©”ì„œë“œê°€ ì™„ì „ížˆ ëë‚  ë•Œ DBì— ë‚´ìš©ì„ ì €ìž¥(Commit)í•œë‹¤.
> - **Service ë‚´ë¶€ì—ì„œ ë½ì„ ê±¸ë©´**: ë©”ì„œë“œ ëì—ì„œ ë½ì„ ë¨¼ì € í’€ê³ , ê·¸ **ë‹¤ìŒì—** DB ì €ìž¥ì´ ì¼ì–´ë‚œë‹¤. (ê·¸ ì‚¬ì´ ì°°ë‚˜ì— ë‹¤ë¥¸ ë†ˆì´ ë“¤ì–´ì™€ì„œ ì‚¬ê³  ë°œìƒ!)
> - **Facadeë¥¼ ì‚¬ìš©í•˜ë©´**: 
>   1. Facadeì—ì„œ ë½ì„ ìž¡ëŠ”ë‹¤.
>   2. Serviceì˜ íŠ¸ëžœìž­ì…˜ ë©”ì„œë“œë¥¼ ë¶€ë¥¸ë‹¤. (DB ì €ìž¥ê¹Œì§€ ì™„ë²½ížˆ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼)
>   3. **DB ì €ìž¥ì´ í™•ì‹¤ížˆ ëë‚œ ë’¤ì—** Facadeì—ì„œ ë½ì„ í‘¼ë‹¤.
>
#### 3. í•´ê²° ì „ëžµ: RedissonLockFacade ì „ì²´ ì½”ë“œ
> ìƒëžµ ì—†ì´ ì‹¤ì œ êµ¬í˜„ëœ ì½”ë“œë¥¼ í†µí•´ ë½ê³¼ íŠ¸ëžœìž­ì…˜ì˜ ì¡°ìœ¨ ê³¼ì •ì„ í™•ì¸í•œë‹¤.
>
> ```java
> @Component
> @RequiredArgsConstructor
> public class RedissonLockFacade {
>
>     private final RedissonClient redissonClient;
>     private final ReservationService reservationService;
>
>     public ReservationResponse createReservation(ReservationRequest request) {
>         String lockKey = "lock:seat:" + request.seatId();
>         RLock lock = redissonClient.getLock(lockKey);
>
>         try {
>             // [ì¤‘ìš” ì„¤ê³„ ë³€ê²½] ì§ìž‘ì— ì˜í•œ ìˆ«ìž(Magic Number) ë°°ì œ
>             // 1. Wait Time: ë¹„ì¦ˆë‹ˆìŠ¤ íƒ€ìž„ì•„ì›ƒ ì •ì±…ì— ë”°ë¼ ì„¤ì • (ex: 10ì´ˆ)
>             // 2. Lease Time: -1ë¡œ ì„¤ì •í•˜ì—¬ Redisson Watchdog(ê°ì‹œê²¬)ì—ê²Œ ê´€ë¦¬ë¥¼ ìœ„ìž„
>             boolean available = lock.tryLock(10, -1, TimeUnit.SECONDS);
>
>             if (!available) {
>                 throw new RuntimeException("ë½ íšë“ ì‹¤íŒ¨: ì„œë²„ê°€ ë°”ì©ë‹ˆë‹¤. ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
>             }
>
>             return reservationService.createReservation(request);
>
>         } catch (InterruptedException e) {
>             Thread.currentThread().interrupt();
>             throw new RuntimeException(e);
>         } finally {
>             if (lock.isHeldByCurrentThread()) {
>                 lock.unlock();
>             }
>         }
>     }
> }
> ```
>
---
>
## ðŸŒŸ [Special] Magic Numberë¥¼ ë°°ì œí•œ ìžìœ¨ì  ì‹œìŠ¤í…œ ì„¤ê³„ (ì¤‘ìš”)
>
> ì´ ì„¹ì…˜ì€ ë‹¨ìˆœížˆ ì½”ë“œë¥¼ ì§œëŠ” ê²ƒì„ ë„˜ì–´, **"ì§„ì •í•œ í”„ë¡œê·¸ëž¨ì´ëž€ ë¬´ì—‡ì¸ê°€"**ì— ëŒ€í•œ ì—”ì§€ë‹ˆì–´ë§ ì² í•™ì„ ë‹¤ë£¬ë‹¤.
>
### 1. ì§ìž‘í•˜ëŠ” ìˆ«ìžì˜ ìœ„í—˜ì„± (Anti-Programming)
> ì´ˆê¸°ì— ìž‘ì„±í–ˆë˜ `lock.tryLock(10, 2, TimeUnit.SECONDS)` ì½”ë“œì—ì„œ `2ì´ˆ`ë¼ëŠ” ìˆ«ìžëŠ” ê°œë°œìžì˜ **'ì§ìž‘'**ì— ë¶ˆê³¼í•˜ë‹¤. 
>
#### âŒ ë‚˜ìœ ì˜ˆì‹œ (Bad Practice: Guessing Numbers)
> ```java
> // ë¡œì§ì´ 2ì´ˆ ì•ˆì— ëë‚  ê²ƒì´ë¼ê³  'ì§ìž‘'í•˜ì—¬ í•˜ë“œì½”ë”©
> // ë§Œì•½ DBê°€ ëŠë ¤ì ¸ 2.1ì´ˆê°€ ê±¸ë¦¬ë©´? -> ë½ì´ í’€ë¦¬ê³  ì¤‘ë³µ ë°ì´í„° ë°œìƒ! ì •í•©ì„± íŒŒê´´!
> boolean available = lock.tryLock(10, 2, TimeUnit.SECONDS); 
> ```
>
#### âœ… ì¢‹ì€ ì˜ˆì‹œ (Best Practice: Autonomous Management)
> ```java
> // 1. ëŒ€ê¸° ì‹œê°„ì€ ì •ì±…(Policy)ìœ¼ë¡œ ê´€ë¦¬
> private static final long MAX_WAIT_TIME = 10L; 
>
> // 2. ì ìœ  ì‹œê°„ì€ -1ë¡œ ì„¤ì •í•˜ì—¬ ì‹œìŠ¤í…œ(Watchdog)ì´ ìŠ¤ìŠ¤ë¡œ íŒë‹¨í•˜ê²Œ í•¨
> // ë¡œì§ì´ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë“  ì•ˆì „í•˜ê²Œ ì •í•©ì„± ìœ ì§€
> boolean available = lock.tryLock(MAX_WAIT_TIME, -1, TimeUnit.SECONDS);
> ```
>
### 2. ì„¤ì • íŒŒì¼(`application.yml`)ì¡°ì°¨ í•˜ë“œì½”ë”©ì´ë‹¤
> ê°’ì„ ì„¤ì • íŒŒì¼ë¡œ ì˜®ê¸°ëŠ” í–‰ìœ„ëŠ” ê´€ë¦¬ì˜ íŽ¸ì˜ì„±ì„ ë†’ì¼ ë¿, ê²°êµ­ ì‚¬ëžŒì´ ì •í•œ **'ì •ì  ìˆ˜ì¹˜'**ë¼ëŠ” ë³¸ì§ˆì€ ë³€í•˜ì§€ ì•ŠëŠ”ë‹¤. ì§„ì •í•œ í•´ê²°ì±…ì€ ì‹œìŠ¤í…œì´ ìƒí™©ì— ë§žì¶° **'ìŠ¤ìŠ¤ë¡œ íŒë‹¨'**í•˜ê²Œ ë§Œë“œëŠ” ê²ƒì´ë‹¤.
>
### 3. ìžìœ¨ì  í•´ê²°ì±…: Redisson Watchdog (ê°ì‹œê²¬) ðŸ•
> ìš°ë¦¬ëŠ” `leaseTime`ì„ `-1`ë¡œ ì„¤ì •í•¨ìœ¼ë¡œì¨ ì´ ë¬¸ì œë¥¼ ìš°ì•„í•˜ê²Œ í•´ê²°í–ˆë‹¤.
> - **ìž‘ë™ ì›ë¦¬**: ë¡œì§ì´ ì‹¤í–‰ ì¤‘ì¸ ë™ì•ˆ Redissonì´ ì£¼ê¸°ì ìœ¼ë¡œ ë½ì˜ ìœ íš¨ì‹œê°„ì„ ì—°ìž¥í•œë‹¤. 
> - **ìž¥ì **: ë¡œì§ì´ 0.1ì´ˆ ë§Œì— ëë‚˜ë“ , 10ì´ˆê°€ ê±¸ë¦¬ë“  **ìƒí™©ì— ë§žì¶° ë½ ìœ ì§€ ì‹œê°„ì„ ìŠ¤ìŠ¤ë¡œ ì¡°ì ˆ**í•œë‹¤.
> - **ì•ˆì „ì„±**: ë§Œì•½ ì„œë²„ê°€ ê°‘ìžê¸° ì£½ì–´ ì—°ìž¥ ì‹ í˜¸ë¥¼ ëª» ë³´ë‚´ë©´, ê·¸ë•Œì„œì•¼ ë½ì„ í•´ì œí•˜ì—¬ ë°ë“œë½(Deadlock)ì„ ë°©ì§€í•œë‹¤.
>
### ðŸ’¡ í•µì‹¬ êµí›ˆ: "ìƒí™©ì„ ë‹¨ì • ì§“ì§€ ë§ê³ , ì‹œìŠ¤í…œì´ íë¥´ê²Œ í•˜ë¼"
> > **"ì„¤ì •ê°’ì€ ìµœì†Œí™”í•˜ê³ , ìžìœ¨ì ì¸ ë©”ì»¤ë‹ˆì¦˜(Watchdog ë“±)ì„ ìš°ì„ ì‹œí•˜ëŠ” ì„¤ê³„ê°€ ëŒ€ê·œëª¨ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì‚´ì•„ë‚¨ëŠ” í”„ë¡œê·¸ëž˜ë° ë°©ì‹ì´ë‹¤."**
>
---
>
#### 4. ì‹¤í—˜ ê²°ê³¼ (ì„±ê³µ)
> - **ì„±ê³µ íšŸìˆ˜**: 1ê±´
> - **ì‹¤íŒ¨ íšŸìˆ˜**: 29ê±´
> - **ìµœì¢… ì˜ˆì•½ ê±´ìˆ˜**: 1ê±´ (ì •í•©ì„± ì™„ë²½ ìœ ì§€)
>
#### 3. í•µì‹¬ ë™ìž‘ ì›ë¦¬
> 1. **ë½ íšë“**: Thread Aê°€ Redis ë½ ì ìœ .
> 2. **íŠ¸ëžœìž­ì…˜ ì‹¤í–‰**: ì„œë¹„ìŠ¤ ê³„ì¸µì˜ íŠ¸ëžœìž­ì…˜ ë©”ì„œë“œ í˜¸ì¶œ ë° **DB ì»¤ë°‹ ì™„ë£Œ**.
> 3. **ë½ í•´ì œ**: íŠ¸ëžœìž­ì…˜ì´ ì™„ì „ížˆ ì¢…ë£Œëœ í›„ Facadeì—ì„œ ë½ í•´ì œ.
> 4. **í›„ì† ì²˜ë¦¬**: Thread Bê°€ ì§„ìž… ì‹œ, ì´ë¯¸ ì»¤ë°‹ëœ `RESERVED` ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ì˜ˆì•½ ë°©ì§€.
>
### 4. ìµœì¢… ê²°ë¡  (Conclusion)
>
> - **ë¹„ê´€ì  ë½**ì€ DB ìžì›ì„ ë§Žì´ ì†Œëª¨í•˜ì§€ë§Œ ì„¤ì •ì´ ê°„íŽ¸í•˜ë‹¤.
>
> - **Redis ë¶„ì‚° ë½**ì€ ì„¤ì •ì´ ë³µìž¡(Facade í•„ìš”)í•˜ì§€ë§Œ, DB ë¶€í•˜ë¥¼ íšë“ ì‹œì  ì´ì „ì— ì°¨ë‹¨í•  ìˆ˜ ìžˆì–´ **ëŒ€ê·œëª¨ íŠ¸ëž˜í”½ì— í›¨ì”¬ ìœ ë¦¬**í•˜ë‹¤.
>
>
>
---
>
>
>
## ðŸš€ ëŒ€ìž¥ì •ì˜ ë‹¤ìŒ ë‹¨ê³„: ì™œ ëŒ€ê¸°ì—´(Kafka)ì¸ê°€?
>
>
>
> ì§€ê¸ˆê¹Œì§€ ìš°ë¦¬ëŠ” **'ë°ì´í„° ì •í•©ì„±'**ì„ ì§€í‚¤ëŠ” ë²•ì„ ë°°ì› ë‹¤. í•˜ì§€ë§Œ ì—¬ì „ížˆ í•´ê²°ë˜ì§€ ì•Šì€ ìˆ™ì œê°€ ë‚¨ì•„ìžˆë‹¤.
>
>
>
### â“ ì§ˆë¬¸: "ë§Œ ëª… ì¤‘ í•œ ëª…ë§Œ ì„±ê³µí•œë‹¤ë©´, ë‚˜ë¨¸ì§€ 9,999ëª…ì€ ì–´ë–»ê²Œ ë˜ëŠ”ê°€?"
>
> ë¶„ì‚° ë½ì€ ì •í•©ì„±ì„ ì§€ì¼œì£¼ì§€ë§Œ, ì‹¤íŒ¨í•œ 9,999ëª…ì—ê²ŒëŠ” "ì‹¤íŒ¨"ë¼ëŠ” ì‘ë‹µë§Œ ëŒë ¤ì¤€ë‹¤. ì‚¬ìš©ìžë“¤ì€ ì„±ê³µí•  ë•Œê¹Œì§€ ê³„ì†í•´ì„œ ë²„íŠ¼ì„ ëˆ„ë¥¼ ê²ƒì´ê³ (ìž¬ì‹œë„), ì´ëŠ” ì„œë²„ì— **'ë¬´í•œ ìž¬ì‹œë„ í­ê²©'**ìœ¼ë¡œ ì´ì–´ì§„ë‹¤.
>
>
>
### ðŸ’¡ í•´ê²°ì±…: 'ë½(Lock)'ì—ì„œ 'ëŒ€ê¸°ì—´(Queue)'ë¡œì˜ íŒ¨ëŸ¬ë‹¤ìž„ ì „í™˜
>
> - **ë½(Lock)**: "í•œ ë†ˆë§Œ ë“¤ì–´ì™€! ë‚˜ë¨¸ì§€ëŠ” ë‹¤ êº¼ì ¸!" (ë°°ì œì™€ ê²½ìŸ)
>
> - **ëŒ€ê¸°ì—´(Queue)**: "ì¼ë‹¨ ëª¨ë‘ ì¤„ ì„œì„¸ìš”. ë²ˆí˜¸í‘œ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬í•´ ë“œë¦´ê²Œìš”." (í¬ìš©ê³¼ ì§ˆì„œ)
>
>
>
### ðŸ—ï¸ Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ì˜ˆì•½ ì‹œìŠ¤í…œ ë„ìž… (Next Phase)
>
> ì´ì œ ìš°ë¦¬ëŠ” ìš”ì²­ì„ ì¦‰ì‹œ ì²˜ë¦¬í•˜ì§€ ì•Šê³  **Kafka**ë¼ëŠ” ì™„ì¶© ì§€ëŒ€ì— ë‹´ì„ ê²ƒì´ë‹¤.
>
> 1. **ìš”ì²­ ìˆ˜ì§‘**: ë§Œ ëª…ì˜ ìš”ì²­ì„ 0.1ì´ˆ ë§Œì— Kafkaì— ìŒ“ëŠ”ë‹¤.
>
> 2. **ë²ˆí˜¸í‘œ ë¶€ì—¬**: ì‚¬ìš©ìžì—ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ëŒ€ê¸° ìˆœë²ˆì„ ì œê³µí•œë‹¤.
>
> 3. **ë¹„ë™ê¸° ì²˜ë¦¬**: ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ì†ë„ë¡œ ë©”ì‹œì§€ë¥¼ êº¼ë‚´ì–´ ì˜ˆì•½ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤.
>
>
>
> **ê²°ê³¼ì ìœ¼ë¡œ, ì„œë²„ëŠ” ì£½ì§€ ì•Šê³  ì‚¬ìš©ìžëŠ” í™”ë‚´ì§€ ì•ŠëŠ” 'ì§„ì •í•œ ê³ ì„±ëŠ¥ ì‹œìŠ¤í…œ'ìœ¼ë¡œ ì§„í™”í•œë‹¤.**
>
>
>
## Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue) âœ…
---
>
### 1. ì™œ 'ëŒ€ê¸°ì—´' ë°©ì‹ì¸ê°€? (The Paradigm Shift)
> ì§€ê¸ˆê¹Œì§€ì˜ **ë½(Lock)** ë°©ì‹ì€ "í•œ ë†ˆë§Œ ë“¤ì–´ì™€, ë‚˜ë¨¸ì§€ëŠ” ë‹¤ ì‹¤íŒ¨ì•¼"ë¼ëŠ” ë°°ì œì  ë°©ì‹ìž…ë‹ˆë‹¤. ì´ëŠ” ë§Œ ëª…ì˜ ì‚¬ìš©ìžê°€ ë™ì‹œì— ì ‘ì†í–ˆì„ ë•Œ 9,999ëª…ì—ê²Œ ë¶ˆì¾Œí•œ ê²½í—˜ì„ ì£¼ë©° ì„œë²„ ìžì›ì„ ê³ ê°ˆì‹œí‚µë‹ˆë‹¤.
> - **Before (Blocking)**: í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ë©´ DB ì˜ˆì•½ì´ ëë‚  ë•Œê¹Œì§€ ìŠ¤ë ˆë“œê°€ ëŒ€ê¸°(Block)í•¨.
> - **After (Event-Driven)**: í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì¦‰ì‹œ Kafkaì— ë‹´ê³  ì‘ë‹µ(Accepted). ì‹¤ì œ ì²˜ë¦¬ëŠ” ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ì†ë„ë¡œ ë‚˜ì¤‘ì— ìˆ˜í–‰.
>
---
>
### 2. êµ¬í˜„ ë°©ë²• (How to Apply)
>
#### 2.1. ìš”ì²­ ìˆ˜ì§‘ (Producer)
> ì‚¬ìš©ìžì˜ ìš”ì²­ì„ ì´ë²¤íŠ¸ ê°ì²´ë¡œ ê°ì‹¸ Kafkaë¡œ ì˜ì•„ ì˜¬ë¦½ë‹ˆë‹¤. ì´ë•Œ **`seatId`ë¥¼ ë©”ì‹œì§€ í‚¤(Key)**ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ í•µì‹¬ìž…ë‹ˆë‹¤.
>
> ```java
> // [KafkaReservationProducer.java]
> public void send(ReservationEvent event) {
>     // seatIdë¥¼ í‚¤ë¡œ ì„¤ì •í•˜ì—¬ ë™ì¼ ì¢Œì„ ìš”ì²­ì€ ë¬´ì¡°ê±´ ê°™ì€ íŒŒí‹°ì…˜(ìˆœì„œ ë³´ìž¥)ìœ¼ë¡œ ì „ì†¡
>     kafkaTemplate.send(topic, String.valueOf(event.getSeatId()), event);
> }
> ```
>
#### 2.2. ë¹„ë™ê¸° ì²˜ë¦¬ (Consumer)
> Kafkaì—ì„œ ë©”ì‹œì§€ë¥¼ í•˜ë‚˜ì”© êº¼ë‚´ì–´ ì‹¤ì œ ì˜ˆì•½ ë¡œì§ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì§€ì •ëœ `lockType`ì— ë”°ë¼ ì•žì„  Step 1~2ì˜ ë¡œì§ì„ ìž¬ì‚¬ìš©í•©ë‹ˆë‹¤.
>
> ```java
> // [KafkaReservationConsumer.java]
> @KafkaListener(topics = "ticket-reservation-events", groupId = "ticket-group")
> public void consume(ReservationEvent event) {
>     // 1. ìƒíƒœë¥¼ PROCESSINGìœ¼ë¡œ ë³€ê²½
>     queueService.setStatus(userId, seatId, "PROCESSING");
>
>     // 2. ì‹¤ì œ ì˜ˆì•½ ì„œë¹„ìŠ¤ í˜¸ì¶œ (Pessimistic or Optimistic)
>     reservationService.createReservationWithPessimisticLock(request);
>
>     // 3. ì„±ê³µ ì‹œ ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
>     sseManager.send(userId, seatId, "SUCCESS");
> }
> ```
>
#### 2.3. ì‹¤ì‹œê°„ ê²°ê³¼ í†µë³´ (SSE)
> ì‚¬ìš©ìžê°€ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šë„ë¡ ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ë°ì´í„°ë¥¼ ë°€ì–´ì£¼ëŠ” SSEë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤.
>
> ```java
> // [SseEmitterManager.java]
> public void send(Long userId, Long seatId, String status) {
>     String key = userId + ":" + seatId;
>     SseEmitter emitter = emitters.get(key);
>     if (emitter != null) {
>         emitter.send(SseEmitter.event().name("RESERVATION_STATUS").data(status));
>         emitter.complete(); // ìž„ë¬´ ì™„ìˆ˜ í›„ ì—°ê²° ì¢…ë£Œ
>     }
> }
> ```
>
### 2. ì½”ë“œ ë³€í™˜ ëŒ€ì¡° (Sync to Async Migration)
>
> ê°œë°œìžê°€ ê¸°ì¡´ ë™ê¸° APIë¥¼ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ ë°©ì‹ìœ¼ë¡œ ì „í™˜í•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìžˆë„ë¡ ì½”ë“œ ë³€í™”ë¥¼ ëŒ€ì¡°í•©ë‹ˆë‹¤.
>
#### âŒ Before: ë™ê¸°ì‹ ìš”ì²­ ì²˜ë¦¬ (Blocking)
> í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ë©´, DB ìž‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ì„œë²„ ìŠ¤ë ˆë“œê°€ ë¶™ìž¡í˜€ ìžˆìŠµë‹ˆë‹¤.
> ```java
> // [Controller]
> @PostMapping("/v1/optimistic")
> public ResponseEntity<ReservationResponse> createReservation(@RequestBody ReservationRequest request) {
>     // ì¦‰ì‹œ ì„œë¹„ìŠ¤ í˜¸ì¶œ -> DB ìž‘ì—… ì™„ë£Œê¹Œì§€ ëŒ€ê¸°(Block)
>     return ResponseEntity.ok(reservationService.createReservation(request));
> }
> ```
>
#### âœ… After: ë¹„ë™ê¸° ì´ë²¤íŠ¸ ê¸°ë°˜ ì²˜ë¦¬ (Non-blocking)
> ìš”ì²­ì„ ë°›ìžë§ˆìž Kafkaì— ì ìž¬í•˜ê³  ì¦‰ì‹œ ì‘ë‹µí•©ë‹ˆë‹¤. ì‹¤ì œ ì²˜ë¦¬ëŠ” ë³„ë„ ì»¨ìŠˆë¨¸ ìŠ¤ë ˆë“œì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤.
> ```java
> // [Controller]
> @PostMapping("/v4/queue")
> public ResponseEntity<String> createAsyncReservation(@RequestBody ReservationRequest request) {
>     // 1. Redisì— ì´ˆê¸° ìƒíƒœ ì €ìž¥
>     queueService.setStatus(request.userId(), request.seatId(), "PENDING");
>
>     // 2. Kafkaë¡œ ì´ë²¤íŠ¸ ë°œí–‰ (ì¦‰ì‹œ ë¦¬í„´)
>     kafkaProducer.send(ReservationEvent.of(request.userId(), request.seatId(), OPTIMISTIC));
>
>     return ResponseEntity.accepted().body("Request Enqueued");
> }
> ```
>
---
>
### 3. ì ìš© ë°©ë²• (Step-by-Step Implementation)
>
> ë¹„ë™ê¸° ì „í™˜ì„ ìœ„í•œ 3ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
>
> 1.  **íŒŒë¼ë¯¸í„°ì˜ ì´ë²¤íŠ¸í™”**: ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë°›ë˜ DTO ë°ì´í„°(`userId`, `seatId`)ë¥¼ Kafka ì „ì†¡ìš© ê°ì²´ì¸ `ReservationEvent`ë¡œ ìº¡ìŠí™”í•©ë‹ˆë‹¤.
> 2.  **í”„ë¡œë“€ì„œ(Producer) ì—°ë™**: ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ `ReservationService` ì˜ì¡´ì„±ì„ ì œê±°í•˜ê³ , ëŒ€ì‹  `KafkaReservationProducer`ë¥¼ ì£¼ìž…ë°›ì•„ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
> 3.  **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì´ê´€ (Consumer)**: ê¸°ì¡´ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ìˆ˜í–‰í•˜ë˜ `reservationService.create...()` í˜¸ì¶œ ì½”ë“œë¥¼ `KafkaReservationConsumer`ì˜ `@KafkaListener` ë©”ì„œë“œ ë‚´ë¶€ë¡œ ì˜®ê¹ë‹ˆë‹¤. ì´ë•Œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ **SSE(SseEmitterManager)**ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì— í†µë³´í•˜ë„ë¡ ì—°ê²°í•©ë‹ˆë‹¤.
>
---
>
### 4. í•µì‹¬ ì„¤ê³„ ê²°ì • ë° ì •í•©ì„± ë³´ìž¥ (ADR)
>
> | ê²°ì • ì‚¬í•­ | ì„¤ê³„ ë‚´ìš© | ê³µí•™ì  ì´ìœ  |
> | :--- | :--- | :--- |
> | **Partition Key** | `seatId` | ë™ì¼ ì¢Œì„ì— ëŒ€í•œ ê²½í•©ì„ ë‹¨ì¼ ì»¨ìŠˆë¨¸ ìŠ¤ë ˆë“œì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•¨ (ë¬¼ë¦¬ì  ìˆœì„œ ë³´ìž¥) |
> | **Status Store** | Redis | ë¹„ë™ê¸° ì²˜ë¦¬ ì¤‘ ì‚¬ìš©ìžê°€ ì–¸ì œë“  ìƒíƒœë¥¼ ì¡°íšŒ(`Polling`)í•  ìˆ˜ ìžˆë„ë¡ ì´ˆê³ ì† ì €ìž¥ì†Œ í™œìš© |
> | **Notification** | SSE | í´ë§ì— ì˜í•œ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ íŠ¸ëž˜í”½ì„ ì¤„ì´ê³  ì‚¬ìš©ìžì—ê²Œ ì¦‰ê°ì ì¸ ë‹¹ì²¨ ê²½í—˜ ì œê³µ |
>
---
>
### 4. ì ìš© íš¨ê³¼ (Experimental Results)
> - **ìžì› íš¨ìœ¨**: DB ì»¤ë„¥ì…˜ì„ ì ìœ í•˜ë©° ëŒ€ê¸°í•˜ëŠ” ìŠ¤ë ˆë“œê°€ ì‚¬ë¼ì§ (ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ ë°©ì§€).
> - **ì‚¬ìš©ìž ê²½í—˜**: "ìž ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”"ë¼ëŠ” í”¼ë“œë°±ê³¼ í•¨ê»˜ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë°›ê²Œ ë¨.
> - **ì•ˆì •ì„±**: ì´ˆë‹¹ 1ë§Œ ê±´ì˜ ìš”ì²­ì´ ë“¤ì–´ì™€ë„ Kafkaê°€ ì™„ì¶© ìž‘ìš©ì„ í•˜ì—¬ ì„œë²„ê°€ ì£½ì§€ ì•ŠìŒ.
>
---
>
## ðŸš€ í–¥í›„ ê³¼ì œ: ì§„ì •í•œ "ê¸°ë‹¤ë¦¼"ì˜ ë¯¸í•™
>
> ì§€ê¸ˆê¹Œì§€ì˜ êµ¬í˜„ì€ "ë¹„ë™ê¸° ì²˜ë¦¬"ì— ì§‘ì¤‘ë˜ì–´ ìžˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ” ì‚¬ìš©ìžì—ê²Œ ì§„ì •í•œ ëŒ€ê¸° ìˆœë²ˆì„ ì œê³µí•˜ëŠ” ì‹œìŠ¤í…œìœ¼ë¡œ ì§„í™”í•©ë‹ˆë‹¤.
>
> - **Step 5: Redis Sorted Set ê¸°ë°˜ ëŒ€ê¸°ì—´**
>   - "ë‚´ ì•žì— ëª‡ ëª…ì´ ë‚¨ì•˜ëŠ”ì§€" ì‹¤ì‹œê°„ ìˆœë²ˆ ì œê³µ.
>   - íŠ¸ëž˜í”½ ê³¼ë¶€í•˜ ì‹œ ì‹œìŠ¤í…œ ì§„ìž… ìžì²´ë¥¼ ì œì–´í•˜ëŠ” Throttling êµ¬í˜„.
>
---
>
> > **Next Step**: Phase 3.5 - Redis Sorted Setì„ ì´ìš©í•œ ì‹¤ì‹œê°„ ëŒ€ê¸° ìˆœë²ˆ í”¼ë“œë°± ì‹œìŠ¤í…œ êµ¬í˜„ ì‹œìž‘.
---
>
## Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ âœ…
---
> [!NOTE]
> **í•µì‹¬ ê°€ì¹˜**: ì‚¬ìš©ìžì—ê²Œ "ë‚´ ì•žì˜ ëŒ€ê¸°ìž ìˆ˜"ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í”¼ë“œë°±í•˜ì—¬ UXë¥¼ í˜ì‹ í•˜ê³ , ì„œë²„ ì¸ìž…ëŸ‰ì„ ì¡°ì ˆí•˜ëŠ” ì¤‘ì¶”ì  ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
>
> ### ðŸ’¡ 1. ê°œìš” (Overview)
> ---
> - ë‹¨ìˆœížˆ Kafkaì— ìš”ì²­ì„ ìŒ“ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‚¬ìš©ìžì˜ ë¶ˆì•ˆê°ì„ í•´ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
> - "ë‚´ ì•žì— 5,000ëª…ì´ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤"ì™€ ê°™ì€ êµ¬ì²´ì ì¸ ì •ë³´ ì œê³µì„ í†µí•´ ì‚¬ìš©ìž ê²½í—˜(UX)ì„ í˜ì‹ í•˜ëŠ” ê²ƒì´ ëª©í‘œìž…ë‹ˆë‹¤.
> 
> ### ðŸ’¡ 2. í•µì‹¬ ë§¤ì»¤ë‹ˆì¦˜: Redis Sorted Set (ZSET)
> ---
> - **Key**: `waiting-queue:concert:{concertId}` (ì½œë¡ `:`ì„ ì‚¬ìš©í•˜ì—¬ ê³„ì¸µ êµ¬ì¡° í‘œí˜„)
> - **Member**: `userId` (ì¤‘ë³µ ë¶ˆê°€ëŠ¥í•œ ì‚¬ìš©ìžì˜ ì‹ë³„ìž)
> - **Score**: `System.currentTimeMillis()` (ì‹œê°„ ê¸°ë°˜ ìžë™ ì •ë ¬)
> - **ìž¥ì **: ì´ì§„ íƒìƒ‰ ê¸°ë°˜ì˜ ì•Œê³ ë¦¬ì¦˜($O(\log N)$)ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë°±ë§Œ ëª… ì¤‘ ë‚´ ìˆœìœ„ë¥¼ ì¦‰ì‹œ ì¡°íšŒ ê°€ëŠ¥.
> 
> ### ðŸ› ï¸ 3. Redis Z-ëª…ë ¹ì–´ ìƒì„¸ ë° Java êµ¬í˜„
> ---
> | ëª…ë ¹ì–´ | ì„¤ëª… | Java í™œìš© ì˜ˆì‹œ |
> | :--- | :--- | :--- |
> | **ZADD** | ëŒ€ê¸°ì—´ ì§„ìž… | `opsForZSet().add(key, userId, score)` |
> | **ZRANK** | ë‚´ ìˆœìœ„ ì¡°íšŒ (0ë²ˆë¶€í„° ì‹œìž‘) | `opsForZSet().rank(key, userId)` |
> | **ZRANGE** | íŠ¹ì • ë²”ìœ„ ëŒ€ê¸°ìž ì¶”ì¶œ | `opsForZSet().range(key, start, stop)` |
> | **ZREM** | ëŒ€ê¸°ì—´ì—ì„œ ì œê±° (ìž…ìž¥ ì²˜ë¦¬) | `opsForZSet().remove(key, userId)` |
> | **ZCARD** | í˜„ìž¬ ëŒ€ê¸°ìž ì´ ì¸ì›ìˆ˜ | `opsForZSet().size(key)` |
> 
> ### ðŸ“ 4. ì‹¤ì œ êµ¬í˜„ ì½”ë“œ (WaitingQueueServiceImpl)
> ---
> ```java
> @Service
> @RequiredArgsConstructor
> public class WaitingQueueServiceImpl implements WaitingQueueService {
>     private final StringRedisTemplate redisTemplate;
>     private static final String QUEUE_KEY_PREFIX = "waiting-queue:";
>     private static final String ACTIVE_KEY_PREFIX = "active-user:";
> 
>     @Override
>     public WaitingQueueResponse join(Long userId, Long concertId) {
>         String queueKey = QUEUE_KEY_PREFIX + concertId;
>         String userIdStr = String.valueOf(userId);
>         if (Boolean.TRUE.equals(redisTemplate.hasKey(ACTIVE_KEY_PREFIX + userIdStr))) {
>             return WaitingQueueResponse.builder().userId(userId).concertId(concertId).status("ACTIVE").rank(0L).build();
>         }
>         redisTemplate.opsForZSet().add(queueKey, userIdStr, System.currentTimeMillis());
>         return getStatus(userId, concertId);
>     }
> 
>     @Override
>     public WaitingQueueResponse getStatus(Long userId, Long concertId) {
>         String queueKey = QUEUE_KEY_PREFIX + concertId;
>         Long rank = redisTemplate.opsForZSet().rank(queueKey, String.valueOf(userId));
>         return WaitingQueueResponse.builder()
>                 .userId(userId).concertId(concertId)
>                 .status(rank != null ? "WAITING" : "NONE")
>                 .rank(rank != null ? rank + 1 : -1L).build();
>     }
> }
> ```
> 
> ### ðŸ§ª 5. ê²€ì¦ ê²°ê³¼ ë° íš¨ê³¼ (Results & Impact)
> ---
> - **ì‹¤ì œ ì¶œë ¥ ë¡œê·¸ (`v5-waiting-queue.sh`)**:
> ```json
>   [User 101] ëŒ€ê¸°ì—´ ì§„ìž… ì„±ê³µ: {"userId":101,"concertId":1,"status":"WAITING","rank":1}
>   [User 102] ëŒ€ê¸°ì—´ ì§„ìž… ì„±ê³µ: {"userId":102,"concertId":1,"status":"WAITING","rank":2}
> ```
> - **ë¹„í¬/ì• í”„í„° ë¹„êµ**:
>   - **Before**: ìš”ì²­ í›„ ê²°ê³¼ ìˆ˜ì‹  ì‹œê¹Œì§€ ìƒíƒœë¥¼ ì•Œ ìˆ˜ ì—†ì–´ ë¶ˆì•ˆ ìœ ë°œ ë° ë¬´ë¶„ë³„í•œ ìƒˆë¡œê³ ì¹¨ ë°œìƒ.
>   - **After**: ì‹¤ì‹œê°„ ìˆœë²ˆ ì œê³µìœ¼ë¡œ ì‚¬ìš©ìž ì‹¬ë¦¬ì  ì•ˆì • í™•ë³´ ë° ì„œë²„ ì¸ìž… íŠ¸ëž˜í”½ ë¶„ì‚°.

---

## Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling) ðŸ‘ˆ
---
> ### ðŸ’¡ 1. ê°œìš” (Overview)
> - ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œì˜ ì™„ì„±ì€ ë‹¨ìˆœížˆ ì¤„ì„ ì„¸ìš°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ì„œë²„ì™€ DBê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ìž„ê³„ì¹˜ë§Œí¼ë§Œ í™œì„± ìƒíƒœë¡œ ì „í™˜í•˜ëŠ” ìœ ìž…ëŸ‰ ì œì–´**ì— ìžˆìŠµë‹ˆë‹¤.
> 
> ### ðŸ› ï¸ 2. í•µì‹¬ ì œì–´ ë§¤ì»¤ë‹ˆì¦˜ (Control Mechanisms)
> - **2.1. ì§„ìž… ì°¨ë‹¨ (Throttling)**: `ZCARD` ëª…ë ¹ì–´ë¡œ í˜„ìž¬ ëŒ€ê¸° ì¸ì›ì„ ì²´í¬í•˜ì—¬ ìž„ê³„ì¹˜ ì´ˆê³¼ ì‹œ ì§„ìž… ê±°ë¶€ ì‘ë‹µ ë°˜í™˜.
> - **2.2. ìœ ìž…ëŸ‰ ë™ì  ì¡°ì ˆ**: ì„œë²„ ìƒíƒœ(CPU, DB ë¶€í•˜)ì— ë”°ë¼ í™œì„±í™” ì¸ì›ìˆ˜ë¥¼ ê°€ë³€ì ìœ¼ë¡œ ìš´ì˜.
> - **2.3. ACTIVE í† í° ê²€ì¦**: ì¸í„°ì…‰í„°ë¥¼ êµ¬í˜„í•˜ì—¬ Redisì— `active-user:{id}` í‚¤ê°€ ì¡´ìž¬í•˜ëŠ” ì‚¬ìš©ìžë§Œ ì˜ˆì•½ í—ˆìš© (ì–´ë·°ì§• ì°¨ë‹¨).
> 
> ### ðŸ”„ 3. ìƒíƒœ ì „ì´ë„ (State Transition)
> - `WAITING (ZSET)` -> `CHECK_THROTTLE` -> `ACTIVE (String + TTL)` -> `RESERVING (API í˜¸ì¶œ)`
---
