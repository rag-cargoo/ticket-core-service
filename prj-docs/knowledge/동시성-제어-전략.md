# ë™ì‹œì„± ì œì–´ ì „ëµ (Concurrency Control Strategy)

> **Purpose**: ì„ ì°©ìˆœ ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œì—ì„œ ë°œìƒí•˜ëŠ” ë°ì´í„° ì •í•©ì„± ë¬¸ì œ í•´ê²° ë° ì„±ëŠ¥ ìµœì í™” ì „ëµ ê¸°ë¡
> **Date**: 2026-02-05

## 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½ (Theory)

| íŠ¹ì§• | ë‚™ê´€ì  ë½ (Optimistic Lock) | ë¹„ê´€ì  ë½ (Pessimistic Lock) |
| :--- | :--- | :--- |
| **ê¸°ë³¸ ì‚¬ìƒ** | "ì¶©ëŒì€ ë“œë¬¼ ê±°ì•¼. ì¶©ëŒ ë‚˜ë©´ ê·¸ë•Œ í•´ê²°í•˜ì." | "ì¶©ëŒì€ ë¹ˆë²ˆí•  ê±°ì•¼. ì•„ì˜ˆ ëª» ê±´ë“œë¦¬ê²Œ ë§‰ì." |
| **êµ¬í˜„ ë°©ì‹** | **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§**: ë²„ì „ ì»¬ëŸ¼(`@Version`) ë¹„êµ. | **DB ì¿¼ë¦¬**: `SELECT ... FOR UPDATE`ë¡œ ë¬¼ë¦¬ì  ë½. |
| **ì„±ëŠ¥ (DB)** | **ë†’ìŒ** (ë½ ëŒ€ê¸° ì—†ìŒ) | **ë‚®ìŒ** (ëŒ€ê¸° ë°œìƒ, ë°ë“œë½ ìœ„í—˜) |
| **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ (`Exception`) -> ë¡¤ë°± -> ì¬ì‹œë„ í•„ìš” | ëŒ€ê¸° (`Wait`) -> ìˆœì°¨ ì²˜ë¦¬ -> ì„±ê³µ |
| **ëŒ€í‘œ ì˜ˆì‹œ** | ê²Œì‹œíŒ ìˆ˜ì •, í”„ë¡œí•„ ì—…ë°ì´íŠ¸ | ì„ ì°©ìˆœ ì˜ˆë§¤, ì¬ê³  ì°¨ê°, ê³„ì¢Œ ì´ì²´ |

---

## ğŸ“‹ ì‹¤í—˜ ê¸°ë¡ ìˆœì„œ (Progress)
1. [Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)](#step-0-ë¬¸ì œ-ìƒí™©-ë½-ë¯¸ì ìš©) - **Completed**
2. [Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)](#step-1-ë‚™ê´€ì -ë½-optimistic-lock) - **Completed**
3. [Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)](#step-2-ë¹„ê´€ì -ë½-pessimistic-lock) - **Completed**
4. [Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)](#) - Pending

---

## Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)

### 1. ì˜ëª»ëœ êµ¬í˜„ ë°©ì‹ (The Wrong Way)
ì•„ë¬´ëŸ° ë³´í˜¸ ì¥ì¹˜ ì—†ì´ ì¼ë°˜ì ì¸ ì¡°íšŒì™€ ìˆ˜ì •ì„ ë°˜ë³µí•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

```java
// [Repository]
Optional<Seat> findById(Long id); // ì¼ë°˜ì ì¸ ì¡°íšŒ

// [Service]
@Transactional
public void reserve(Long seatId) {
    Seat seat = seatRepository.findById(seatId).orElseThrow(); // 1. ëˆ„êµ¬ë‚˜ ë™ì‹œì— ì¡°íšŒ ê°€ëŠ¥
    seat.reserve(); // 2. ê°ì ë©”ëª¨ë¦¬ ìƒì—ì„œ ìƒíƒœ ë³€ê²½
    // 3. ì»¤ë°‹ ì‹œì ì— ë§ˆì§€ë§‰ì— ë“¤ì–´ì˜¨ ë†ˆì´ ë®ì–´ì“°ê±°ë‚˜ ì¤‘ë³µ ìƒì„±ë¨ (Race Condition)
}
```

### 2. ì‹¤í—˜ ê²°ê³¼ (ì‹¤íŒ¨)
*   **ì‹œë‚˜ë¦¬ì˜¤**: 30ëª…ì˜ ìœ ì €ê°€ ë™ì‹œì— 1ê°œ ì¢Œì„ ì˜ˆì•½ ì‹œë„.
*   **ê²°ê³¼**: **10ëª… ì¤‘ë³µ ì˜ˆì•½ ì„±ê³µ** (ë°ì´í„° ì •í•©ì„± ê¹¨ì§).
*   **ì›ì¸**: Thread Aê°€ ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ê¸° ì „ì— Thread Bê°€ `AVAILABLE` ìƒíƒœì˜ ì¢Œì„ì„ ì½ì–´ê°”ê¸° ë•Œë¬¸.

---

## Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)

### 1. êµ¬í˜„ ë°©ë²• (How to Apply)
ì—”í‹°í‹°ì— `@Version` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì˜ ì²´í¬ ë¡œì§**ì´ í™œì„±í™”ë©ë‹ˆë‹¤.

```java
// [Entity]
@Entity
public class Seat {
    @Id @GeneratedValue
    private Long id;

    @Version // JPAê°€ ì œê³µí•˜ëŠ” ë‚™ê´€ì  ë½ ë©”ì»¤ë‹ˆì¦˜
    private Long version;
    
    private SeatStatus status;
}
```

### 2. ë™ì‘ ì›ë¦¬ ë° SQL
ìˆ˜ì • ì¿¼ë¦¬ ì‹œì ì— ìë™ìœ¼ë¡œ **ë²„ì „ ì²´í¬ ì¡°ê±´**ì´ ë¶™ìŠµë‹ˆë‹¤.
```sql
update seats 
set status='RESERVED', version=1 -- ë²„ì „ ì¦ê°€
where id=1 and version=0; -- ë‚´ê°€ ì²˜ìŒ ì½ì€ ë²„ì „ì´ 0ì¼ ë•Œë§Œ ì„±ê³µ!
```
*   **ì‹¤íŒ¨ ì‹œ**: Hibernateê°€ `ObjectOptimisticLockingFailureException`ì„ ë˜ì§€ë©° íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±ì‹œí‚µë‹ˆë‹¤.

### 3. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
*   **ì„±ê³µ íšŸìˆ˜**: 1ê±´
*   **ì‹¤íŒ¨ íšŸìˆ˜**: 29ê±´ (ì˜ˆì™¸ ë°œìƒ)
*   **ê²°ë¡ **: ë°ì´í„° ê¼¬ì„ì€ ë§‰ì•˜ìœ¼ë‚˜, 29ëª…ì—ê²Œ ì—ëŸ¬ë¥¼ ë³´ì—¬ì£¼ë¯€ë¡œ **ì„ ì°©ìˆœ ì˜ˆë§¤ì—ëŠ” ë¶€ì í•©**í•¨.

---

## Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)

### 1. êµ¬í˜„ ë°©ë²• (How to Apply)
ì¿¼ë¦¬ ì‹œì ì— **DBì˜ ë°°íƒ€ ë½(Exclusive Lock)**ì„ ì§ì ‘ ì‚¬ìš©í•˜ë„ë¡ ëª…ì‹œí•©ë‹ˆë‹¤.

```java
// [Repository]
public interface SeatRepository extends JpaRepository<Seat, Long> {
    
    @Lock(LockModeType.PESSIMISTIC_WRITE) // SELECT ... FOR UPDATE ì‹¤í–‰
    @Query("SELECT s FROM Seat s WHERE s.id = :id")
    Optional<Seat> findByIdWithPessimisticLock(@Param("id") Long id);
}
```

### 2. ë™ì‘ ì›ë¦¬ ë° SQL
ë°ì´í„°ë¥¼ ì½ëŠ” ì‹œì ë¶€í„° DBê°€ ë‹¤ë¥¸ ë†ˆë“¤ì„ ëª» ë“¤ì–´ì˜¤ê²Œ ë§‰ìŠµë‹ˆë‹¤.
```sql
select s1_0.id, ... 
from seats s1_0 
where s1_0.id=? 
for update; -- DB ì—”ì§„ì´ í•´ë‹¹ í–‰(Row)ì„ ê½‰ ì¡ìŒ (ìë¬¼ì‡ )
```

### 3. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
*   **ì„±ê³µ íšŸìˆ˜**: 1ê±´
*   **ì‹¤íŒ¨ íšŸìˆ˜**: 29ê±´ (ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì—ì„œ "ì´ë¯¸ ì˜ˆì•½ë¨"ìœ¼ë¡œ ì²˜ë¦¬)
*   **ë™ì‘ ë°©ì‹**: 
    1. Thread Aê°€ `for update`ë¡œ ì¡°íšŒ (ë½ íšë“).
    2. Thread BëŠ” Thread Aê°€ ëë‚  ë•Œê¹Œì§€ ì¿¼ë¦¬ ê²°ê³¼ë„ ëª» ë°›ê³  **ëŒ€ê¸°(Wait)**.
    3. Thread A ì»¤ë°‹ í›„ ë½ í•´ì œ.
    4. Thread Bê°€ ì§„ì…í–ˆìœ¼ë‚˜ ì´ë¯¸ Aê°€ ê³ ì³ë†“ì€ ìƒíƒœë¥¼ ë³´ê²Œ ë˜ì–´ ì•ˆì „í•˜ê²Œ ì‹¤íŒ¨ ì²˜ë¦¬ë¨.

### 4. ê²°ë¡  (Conclusion)
*   **ë¹„ê´€ì  ë½ì€ ì¿¼ë¦¬ë¡œ í•´ê²°í•œë‹¤**: ì½”ë“œ ë¡œì§ì´ ì•„ë‹ˆë¼ DB ì—”ì§„ì˜ í˜ì„ ë¹Œë ¤ **ì¤„ì„ ì„¸ìš°ëŠ” ë°©ì‹**ì´ë‹¤.
*   **ì¥ì **: ë‚™ê´€ì  ë½ë³´ë‹¤ ì •í•©ì„±ì´ ê°•ë ¥í•˜ê³ , ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ì¬ì‹œë„ ë¡œì§ì´ í•„ìš” ì—†ë‹¤.
*   **ë‹¨ì **: ëŒ€ê¸° ì‹œê°„ì´ ê¸¸ì–´ì§€ë©´ DB ì „ì²´ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤€ë‹¤.

---
> **Next Work**: DB ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ Redisë¥¼ ì‚¬ìš©í•œ **ë¶„ì‚° ë½(Distributed Lock)** ì‹¤í—˜ ì˜ˆì •.
