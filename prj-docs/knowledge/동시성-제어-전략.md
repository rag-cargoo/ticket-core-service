# ë™ì‹œì„± ì œì–´ ì „ëµ (Concurrency Control Strategy)

> **Purpose**: ì„ ì°©ìˆœ ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œì—ì„œ ë°œìƒí•˜ëŠ” ë°ì´í„° ì •í•©ì„± ë¬¸ì œ í•´ê²° ë° ì„±ëŠ¥ ìµœì í™” ì „ëµ ê¸°ë¡
> **Date**: 2026-02-05

## 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½ (Theory)

| íŠ¹ì§• | ë‚™ê´€ì  ë½ (Optimistic Lock) | ë¹„ê´€ì  ë½ (Pessimistic Lock) |
| :--- | :--- | :--- |
| **ê¸°ë³¸ ì‚¬ìƒ** | "ì¶©ëŒì€ ë“œë¬¼ ê±°ì•¼. ì¶©ëŒ ë‚˜ë©´ ê·¸ë•Œ í•´ê²°í•˜ì." | "ì¶©ëŒì€ ë¹ˆë²ˆí•  ê±°ì•¼. ì•„ì˜ˆ ëª» ê±´ë“œë¦¬ê²Œ ë§‰ì." |
| **êµ¬í˜„ ë°©ì‹** | **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§**: ë²„ì „ ì»¬ëŸ¼(`@Version`) ë¹„êµ. | **DB ì¿¼ë¦¬**: `SELECT ... FOR UPDATE`ë¡œ ë¬¼ë¦¬ì  ë½. |
| **ì„±ëŠ¥ (DB)** | **ë†’ìŒ** (ë½ ëŒ€ê¸° ì—†ìŒ) | **ë‚®ìŒ** (ëŒ€ê¸° ë°œìƒ, ë°ë“œë½ ìœ„í—˜) |
| **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ (`Exception`) -> ë¡¤ë°± -> ì¬ì‹œë„ í•„ìš” | ëŒ€ê¸° (`Wait`) -> ìˆœì°¨ ì²˜ë¦¬ -> ì„±ê³µ |
| **ëŒ€í‘œ ì˜ˆì‹œ** | ê²Œì‹œíŒ ìˆ˜ì •, í”„ë¡œí•„ ì—…ë°ì´íŠ¸ | ì„ ì°©ìˆœ ì˜ˆë§¤, ì¬ê³  ì°¨ê°, ê³„ì¢Œ ì´ì²´ |

---

## ğŸ“‹ ì‹¤í—˜ ê¸°ë¡ ìˆœì„œ (Progress)
1. [Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)](#step-0-ë¬¸ì œ-ìƒí™©-ë½-ë¯¸ì ìš©) - **Completed**
2. [Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)](#step-1-ë‚™ê´€ì -ë½-optimistic-lock) - **Completed**
3. [Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)](#step-2-ë¹„ê´€ì -ë½-pessimistic-lock) - **Completed**
4. [Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)](#step-3-redis-ë¶„ì‚°-ë½-distributed-lock) - **Completed**
5. [Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue)](#step-4-kafka-ê¸°ë°˜-ë¹„ë™ê¸°-ëŒ€ê¸°ì—´-async-queue) - **Completed**
6. [Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´](#step-5-redis-sorted-set-ê¸°ë°˜-ì‹¤ì‹œê°„-ëŒ€ê¸°ì—´) - **Completed**
7. [Step 6: ìœ ì…ëŸ‰ ì œì–´ ì „ëµ (Throttling)](#step-6-ìœ ì…ëŸ‰-ì œì–´-ì „ëµ-throttling) - **In Progress**

---

## Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)
... (ìƒëµëœ ê¸°ì¡´ ë‚´ìš© ìœ ì§€) ...

## Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue) âœ…
... (ìƒëµëœ ê¸°ì¡´ ë‚´ìš© ìœ ì§€) ...

---

## Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ âœ…

### 1. ê°œìš” (Overview)
ë‹¨ìˆœíˆ Kafkaì— ìš”ì²­ì„ ìŒ“ëŠ” ê²ƒ(Step 4)ë§Œìœ¼ë¡œëŠ” ì‚¬ìš©ìì˜ ë¶ˆì•ˆê°ì„ í•´ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "ë‚´ ì•ì— 5,000ëª…ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤"ì™€ ê°™ì€ êµ¬ì²´ì ì¸ ì •ë³´ ì œê³µì´ í•„ìš”í•©ë‹ˆë‹¤.

### 2. í•µì‹¬ ë§¤ì»¤ë‹ˆì¦˜: Redis Sorted Set (ZSET)
- **Key**: `waiting-queue:concert:{concertId}`
- **Member**: `userId`
- **Score**: `System.currentTimeMillis()` (ë„ì°© ì‹œê°„ ê¸°ë°˜ ìë™ ì •ë ¬)

### 3. Redis Z-ëª…ë ¹ì–´ ìƒì„¸ ë° Java êµ¬í˜„

| ëª…ë ¹ì–´ (Redis CLI) | ì„¤ëª… (Description) | Java í™œìš© ì˜ˆì‹œ (StringRedisTemplate) |
| :--- | :--- | :--- |
| **ZADD** | ëŒ€ê¸°ì—´ ì§„ì… | `opsForZSet().add(key, userId, score)` |
| **ZRANK** | ë‚´ ìˆœìœ„ ì¡°íšŒ | `opsForZSet().rank(key, userId)` |
| **ZRANGE** | íŠ¹ì • ë²”ìœ„ ëŒ€ê¸°ì ì¶”ì¶œ | `opsForZSet().range(key, start, stop)` |
| **ZREM** | ëŒ€ê¸°ì—´ì—ì„œ ì œê±° | `opsForZSet().remove(key, userId)` |

---

## Step 6: ìœ ì…ëŸ‰ ì œì–´ ì „ëµ (Throttling) ğŸ‘ˆ (Next)

### 1. ê°œìš” (Overview)
ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œì˜ ì™„ì„±ì€ ë‹¨ìˆœíˆ ì¤„ì„ ì„¸ìš°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ë§Œí¼ë§Œ ë“¤ì—¬ë³´ë‚´ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.

### 2. í•µì‹¬ ì œì–´ ë§¤ì»¤ë‹ˆì¦˜
- **ì§„ì… ì°¨ë‹¨ (Throttling)**: `ZCARD` ëª…ë ¹ì–´ë¡œ í˜„ì¬ ëŒ€ê¸° ì¸ì›ì„ ì²´í¬í•˜ì—¬ ì„ê³„ì¹˜ ì´ˆê³¼ ì‹œ ì§„ì… ê±°ë¶€.
- **ìœ ì…ëŸ‰ ë™ì  ì¡°ì ˆ (Dynamic Batching)**: ìŠ¤ì¼€ì¤„ëŸ¬ê°€ í™œì„±í™”í•˜ëŠ” ì¸ì›(`activateCount`)ì„ ìœ ë™ì ìœ¼ë¡œ ê´€ë¦¬.
- **ACTIVE í† í° ê²€ì¦ (Security)**: `ActiveUserInterceptor`ë¥¼ í†µí•´ ACTIVE ìƒíƒœì¸ ì‚¬ìš©ìë§Œ ì˜ˆì•½ API í˜¸ì¶œ í—ˆìš©.
