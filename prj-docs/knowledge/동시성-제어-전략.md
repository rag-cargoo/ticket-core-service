# ë™ì‹œì„± ì œì–´ ë° ê³ ì„±ëŠ¥ ëŒ€ê¸°ì—´ ì „ëžµ (Concurrency & Queue Strategy)

> **Purpose**: ì„ ì°©ìˆœ ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ì •í•©ì„± í•´ê²°ë¶€í„° ì´ˆê³ ì† ëŒ€ê¸°ì—´ ì„¤ê³„ê¹Œì§€ì˜ ê¸°ìˆ ì  ì—¬ì •
> **Date**: 2026-02-07

---

## ëª©ì°¨ (Table of Contents)
---
>   - 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½
>   - Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)
>   - Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)
>   - Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)
>   - ë½(Lock)ì˜ í•œê³„ì™€ í˜„ì‹¤ì ì¸ ë¬¸ì œ
>   - Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)
>   - Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue)
>   - Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´
>   - Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling)

---

## 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½ (Theory)
---
> [!TIP]
> **í•µì‹¬ ì‚¬ìƒ**: ë°ì´í„° ì •í•©ì„±ì„ ë³´ìž¥í•˜ê¸° ìœ„í•´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨(ë‚™ê´€ì ) ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ ë ˆë²¨(ë¹„ê´€ì )ì—ì„œ ì ‘ê·¼ ìˆœì„œë¥¼ ì œì–´í•˜ëŠ” ê¸°ì´ˆ ì „ëžµìž…ë‹ˆë‹¤.
> 
> | íŠ¹ì§• | ë‚™ê´€ì  ë½ (Optimistic Lock) | ë¹„ê´€ì  ë½ (Pessimistic Lock) |
> | :--- | :--- | :--- |
> | **ê¸°ë³¸ ì‚¬ìƒ** | "ì¶©ëŒì€ ë“œë¬¼ ê±°ì•¼. ì¶©ëŒ ë‚˜ë©´ ê·¸ë•Œ í•´ê²°í•˜ìž." | "ì¶©ëŒì€ ë¹ˆë²ˆí•  ê±°ì•¼. ì•„ì˜ˆ ëª» ê±´ë“œë¦¬ê²Œ ë§‰ìž." |
> | **êµ¬í˜„ ë°©ì‹** | **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§**: ë²„ì „ ì»¬ëŸ¼(@Version) ë¹„êµ. | **DB ì¿¼ë¦¬**: SELECT ... FOR UPDATEë¡œ ë¬¼ë¦¬ì  ë½. |
> | **ì„±ëŠ¥ (DB)** | **ë†’ìŒ** (ë½ ëŒ€ê¸° ì—†ìŒ) | **ë‚®ìŒ** (ëŒ€ê¸° ë°œìƒ, ë°ë“œë½ ìœ„í—˜) |
> | **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ (Exception) -> ë¡¤ë°± -> ìž¬ì‹œë„ í•„ìš” | ëŒ€ê¸° (Wait) -> ìˆœì°¨ ì²˜ë¦¬ -> ì„±ê³µ |
> | **ëŒ€í‘œ ì˜ˆì‹œ** | ê²Œì‹œíŒ ìˆ˜ì •, í”„ë¡œí•„ ì—…ë°ì´íŠ¸ | ì„ ì°©ìˆœ ì˜ˆë§¤, ìž¬ê³  ì°¨ê°, ê³„ì¢Œ ì´ì²´ |

---

## Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)
---
> [!ATTENTION]
> **ë°ì´í„° ì†Œì‹¤ ìœ„í—˜**: ì•„ë¬´ëŸ° ë³´í˜¸ ìž¥ì¹˜ê°€ ì—†ì„ ê²½ìš°, ë§ˆì§€ë§‰ì— ë“¤ì–´ì˜¨ ìš”ì²­ì´ ì´ì „ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ë®ì–´ì“°ëŠ” Race Conditionì´ ë°œìƒí•©ë‹ˆë‹¤.
> 
> ### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> ---
>   - ëŒ€ìƒ: 1ê°œ ì¢Œì„ (Seat ID: 1)
>   - ë¶€í•˜: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
> 
> ### 2. ìž˜ëª»ëœ êµ¬í˜„ ë°©ì‹ (The Wrong Way)
> ---
>   - ì•„ë¬´ëŸ° ë³´í˜¸ ìž¥ì¹˜ ì—†ì´ ì¼ë°˜ì ì¸ ì¡°íšŒì™€ ìˆ˜ì •ì„ ë°˜ë³µí•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.
>   ```java
>   @Transactional
>   public void reserve(Long seatId) {
>       Seat seat = seatRepository.findById(seatId).orElseThrow();
>       seat.reserve();
>   }
>   ```
> 
> ### 3. ì‹¤í—˜ ê²°ê³¼ (ì‹¤íŒ¨)
> ---
>   - ë°ì´í„° ì •í•©ì„±ì´ ì™„ì „ížˆ ê¹¨ì§€ëŠ” í˜„ìƒì´ ë°œìƒí•¨. (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)
>   - ì„±ê³µ íšŸìˆ˜: 10ê±´ (ì¹˜ëª…ì  ì˜¤ë¥˜)
>   - ìµœì¢… ì˜ˆì•½ ê±´ìˆ˜: 10ê±´ (Race Condition ë°œìƒ)

---

## Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)
---
> [!TIP]
> **ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì œì–´**: ì—”í‹°í‹°ì˜ ë²„ì „ì„ ì²´í¬í•˜ì—¬ ì¶©ëŒì„ ê°ì§€í•©ë‹ˆë‹¤. DB ë¶€í•˜ê°€ ì ì§€ë§Œ ì¶©ëŒ ì‹œ ìž¬ì‹œë„ ë¡œì§ì´ í•„ìš”í•©ë‹ˆë‹¤.
> 
> ### 1. êµ¬í˜„ ë°©ë²• (How to Apply)
> ---
>   - ì—”í‹°í‹°ì— @Version ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì˜ ì²´í¬ ë¡œì§ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
>   ```java
>   @Version 
>   private Long version;
>   ```
> 
> ### 2. ë™ìž‘ ì›ë¦¬ ë° SQL
> ---
>   - ìˆ˜ì • ì¿¼ë¦¬ ì‹œì ì— ìžë™ìœ¼ë¡œ ë²„ì „ ì²´í¬ ì¡°ê±´ì´ ë¶™ìŠµë‹ˆë‹¤.
>   ```sql
>   update seats set status='RESERVED', version=1 where id=1 and version=0;
>   ```
> 
> ### 3. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
> ---
>   - ì„±ê³µ íšŸìˆ˜: 1ê±´
>   - ì‹¤íŒ¨ íšŸìˆ˜: 29ê±´ (FailureException ë°œìƒ)
>   - ê²°ë¡ : ë°ì´í„° ì •í•©ì„±ì€ ë³´ìž¥í•˜ë‚˜, ì¶©ëŒ ì‹œ ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ UXì— í•œê³„ê°€ ìžˆìŒ.

---

## Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)
---
> [!TIP]
> **DB ì—”ì§„ ë ˆë²¨ ì œì–´**: SELECT ... FOR UPDATEë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ìž ê¸‰ë‹ˆë‹¤. ê°•ë ¥í•œ ì •í•©ì„±ì„ ë³´ìž¥í•©ë‹ˆë‹¤.
> 
> ### 1. êµ¬í˜„ ë°©ë²• (How to Apply)
> ---
>   - Spring Data JPAì—ì„œ ì œê³µí•˜ëŠ” @Lock ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©ì„ ê¶Œìž¥í•©ë‹ˆë‹¤.
>   ```java
>   public interface SeatRepository extends JpaRepository<Seat, Long> {
>       @Lock(LockModeType.PESSIMISTIC_WRITE)
>       @Query("SELECT s FROM Seat s WHERE s.id = :id")
>       Optional<Seat> findByIdWithPessimisticLock(@Param("id") Long id);
>   }
>   ```
> 
> ### 2. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
> ---
>   - ìž¥ì : ê°•ë ¥í•œ ì •í•©ì„± ë³´ìž¥, ë³„ë„ ìž¬ì‹œë„ ë¡œì§ ë¶ˆí•„ìš”.
>   - ë‹¨ì : ëŒ€ê¸° ì‹œê°„ì´ ê¸¸ì–´ì§€ë©´ DB ì»¤ë„¥ì…˜ í’€ ë§ˆë¹„ ìœ„í—˜.

---

## ðŸš¨ ë½(Lock)ë§Œìœ¼ë¡œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” í˜„ì‹¤ì ì¸ ë¬¸ì œ
---
> [!WARNING]
> **ì‹œìŠ¤í…œ í•œê³„**: ë½ ì •ì²´ëŠ” DB ì»¤ë„¥ì…˜ í’€ì„ ë§ˆë¹„ì‹œí‚¤ê³  ì‚¬ìš©ìžì—ê²Œ ë¶ˆì¾Œí•œ ê²½í—˜(ë¬´ì¡°ê±´ ì‹¤íŒ¨)ì„ ì œê³µí•©ë‹ˆë‹¤.
> 
> ### 1. ì‚¬ìš©ìž ê²½í—˜(UX)ì˜ íŒŒê´´
> ---
>   - í˜„ìž¬ ë°©ì‹ì€ 1ëª…ì´ ë½ì„ ìž¡ê³  ìžˆëŠ” ë™ì•ˆ ë‚˜ë¨¸ì§€ëŠ” ëŒ€ê¸°í•˜ê±°ë‚˜ ì—ëŸ¬ë¥¼ ë°›ëŠ”ë‹¤. 1ë§Œ ëª… ì¤‘ 9,999ëª…ì€ ë¬´ì¡°ê±´ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë³´ê²Œ ë¨.
> 
> ### 2. ì„œë²„ ìžì› ê³ ê°ˆ
> ---
>   - ë¹„ê´€ì  ë½(FOR UPDATE)ì€ DB ì»¤ë„¥ì…˜ì„ ì ìœ í•œ ì±„ë¡œ ëŒ€ê¸°í•˜ì—¬ ì „ì²´ ì„œë²„ ë§ˆë¹„ ìƒíƒœ(Cascading Failure)ë¥¼ ìœ ë°œ.
> 
> ### ðŸ’¡ í•´ê²° ë°©í–¥: Redis ë¶„ì‚° ë½ê³¼ ëŒ€ê¸°ì—´
> ---
>   - ì²´ë ¥ ê°•í™”: ì´ˆê³ ì† Redisì—ì„œ ë½ì„ ì²˜ë¦¬í•˜ì—¬ DB ë¶€í•˜ ì›ì²œ ì°¨ë‹¨.
>   - ì§ˆì„œ í™•ë¦½: ì‹¤íŒ¨ê°€ ì•„ë‹Œ ëŒ€ê¸°ì—´(Queue)ì„ ë„ìž…í•˜ì—¬ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” UX ì œê³µ.

---

## Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)
---
> [!NOTE]
> **ë¶„ì‚° í™˜ê²½ ì •í•©ì„±**: ì„œë²„ê°€ ì—¬ëŸ¬ ëŒ€ì¸ ë¶„ì‚° í™˜ê²½ì—ì„œ ë‹¨ì¼ DB ë½ì˜ í•œê³„ë¥¼ ë„˜ì–´, ê³µí†µ ì €ìž¥ì†Œì¸ Redisë¥¼ í†µí•´ ìž„ê³„ ì˜ì—­ì„ ë³´í˜¸í•©ë‹ˆë‹¤.
> 
> ### 1. RedissonLockFacade ë„ìž… ë°°ê²½
> ---
>   - ë½ í•´ì œ ì‹œì ê³¼ íŠ¸ëžœìž­ì…˜ ì»¤ë°‹ ì‹œì ì˜ ë¶ˆì¼ì¹˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë³„ë„ì˜ Facade í´ëž˜ìŠ¤ë¥¼ ë‘ì–´ ë½ì„ ìž¡ê³ , ê·¸ ì•ˆì—ì„œ íŠ¸ëžœìž­ì…˜ ì„œë¹„ìŠ¤(createReservation)ë¥¼ í˜¸ì¶œí•˜ì—¬ DB ì €ìž¥ì´ ì™„ë²½ížˆ ëë‚œ ë’¤ì— ë½ì„ í’€ë„ë¡ ì„¤ê³„í•©ë‹ˆë‹¤.
> 
> ### 2. Magic Numberë¥¼ ë°°ì œí•œ ìžìœ¨ì  ì„¤ê³„ (ì¤‘ìš”)
> ---
>   - ì§ìž‘í•˜ëŠ” ìˆ«ìžì˜ ìœ„í—˜ì„±: lock.tryLock(10, 2, ...) ì½”ë“œì—ì„œ '2ì´ˆ'ëŠ” ê°œë°œìžì˜ ì§ìž‘ì¼ ë¿, DB ë¶€í•˜ ì‹œ ì •í•©ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìžˆìŒ.
>   - ìžìœ¨ì  í•´ê²°ì±…: Redisson Watchdog (ê°ì‹œê²¬): leaseTimeì„ -1ë¡œ ì„¤ì •í•˜ì—¬ Redissonì´ ì£¼ê¸°ì ìœ¼ë¡œ ë½ì˜ ìœ íš¨ì‹œê°„ì„ ì—°ìž¥í•˜ê²Œ í•¨. ë¡œì§ì´ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë“  ìƒí™©ì— ë§žì¶° ë½ ìœ ì§€ ì‹œê°„ì„ ìŠ¤ìŠ¤ë¡œ ì¡°ì ˆí•˜ë©°, ì„œë²„ ë§ˆë¹„ ì‹œ ìžë™ìœ¼ë¡œ ë½ì„ í•´ì œí•˜ì—¬ ë°ë“œë½ ë°©ì§€.
>   - í•µì‹¬ êµí›ˆ: "ìƒí™©ì„ ë‹¨ì • ì§“ì§€ ë§ê³ , ì‹œìŠ¤í…œì´ íë¥´ê²Œ í•˜ë¼."
> 
> ### 3. êµ¬í˜„ ì½”ë“œ (RedissonLockFacade)
> ---
> ```java
> @Component
> @RequiredArgsConstructor
> public class RedissonLockFacade {
>     private final RedissonClient redissonClient;
>     private final ReservationService reservationService;
>     public ReservationResponse createReservation(ReservationRequest request) {
>         String lockKey = "lock:seat:" + request.seatId();
>         RLock lock = redissonClient.getLock(lockKey);
>         try {
>             boolean available = lock.tryLock(10, -1, TimeUnit.SECONDS); // Watchdog í™œì„±í™”
>             if (!available) throw new RuntimeException("ë½ íšë“ ì‹¤íŒ¨");
>             return reservationService.createReservation(request);
>         } catch (InterruptedException e) {
>             Thread.currentThread().interrupt();
>             throw new RuntimeException(e);
>         } finally {
>             if (lock.isHeldByCurrentThread()) {
>                 lock.unlock();
>             }
>         }
>     }
> }
> ```

---

## Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue) âœ…
---
> [!NOTE]
> **íŒ¨ëŸ¬ë‹¤ìž„ì˜ ì „í™˜**: ê²½ìŸ ê¸°ë°˜ì˜ 'ë½'ì—ì„œ ì§ˆì„œ ê¸°ë°˜ì˜ 'ëŒ€ê¸°ì—´'ë¡œ ì „í™˜í•˜ì—¬ ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ì†ë„ë¡œ ë¶€í•˜ë¥¼ ë¶„ì‚° ì²˜ë¦¬í•©ë‹ˆë‹¤.
> 
> ### 1. ì™œ 'ëŒ€ê¸°ì—´' ë°©ì‹ì¸ê°€? (The Paradigm Shift)
> ---
>   - Before (Blocking): í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ë©´ DB ì˜ˆì•½ì´ ëë‚  ë•Œê¹Œì§€ ì„œë²„ ìŠ¤ë ˆë“œê°€ ë¶™ìž¡í˜€ ìžˆìŒ.
>   - After (Event-Driven): í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì¦‰ì‹œ Kafkaì— ë‹´ê³  ì‘ë‹µ(Accepted). ì‹¤ì œ ì²˜ë¦¬ëŠ” ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ì†ë„ë¡œ ë‚˜ì¤‘ì— ìˆ˜í–‰.
> 
> ### 2. ì½”ë“œ ë³€í™˜ ëŒ€ì¡° (Sync to Async Migration)
> ---
>   - **Before: ë™ê¸°ì‹ ìš”ì²­ ì²˜ë¦¬ (Blocking)**
>   ```java
>   @PostMapping("/v1/optimistic")
>   public ResponseEntity<ReservationResponse> createReservation(@RequestBody ReservationRequest request) {
>       return ResponseEntity.ok(reservationService.createReservation(request));
>   }
>   ```
>   - **After: ë¹„ë™ê¸° ì´ë²¤íŠ¸ ê¸°ë°˜ ì²˜ë¦¬ (Non-blocking)**
>   ```java
>   @PostMapping("/v4/queue")
>   public ResponseEntity<String> createAsyncReservation(@RequestBody ReservationRequest request) {
>       queueService.setStatus(request.userId(), request.seatId(), "PENDING");
>       kafkaProducer.send(ReservationEvent.of(request.userId(), request.seatId(), OPTIMISTIC));
>       return ResponseEntity.accepted().body("Request Enqueued");
>   }
>   ```
> 
> ### ðŸ“Š 3. í•µì‹¬ ì„¤ê³„ ê²°ì • (ADR)
> ---
> | ê²°ì • ì‚¬í•­ | ì„¤ê³„ ë‚´ìš© | ê³µí•™ì  ì´ìœ  |
> | :--- | :--- | :--- |
> | Partition Key | `seatId` | ë™ì¼ ì¢Œì„ ê²½í•©ì„ ë‹¨ì¼ ì»¨ìŠˆë¨¸ ìŠ¤ë ˆë“œì—ì„œ ìˆœì°¨ ì²˜ë¦¬ ë³´ìž¥ |
> | Status Store | Redis | ë¹„ë™ê¸° ì²˜ë¦¬ ì¤‘ ì‹¤ì‹œê°„ ìƒíƒœ ì¡°íšŒë¥¼ ìœ„í•œ ì´ˆê³ ì† ì €ìž¥ì†Œ |
> | Notification | SSE | ì‚¬ìš©ìžì—ê²Œ ì¦‰ê°ì ì¸ ë‹¹ì²¨ ê²½í—˜ ì œê³µ ë° íŠ¸ëž˜í”½ ë¶„ì‚° |

---

## Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ âœ…
---
> [!NOTE]
> **í•µì‹¬ ê°€ì¹˜**: ì‚¬ìš©ìžì—ê²Œ "ë‚´ ì•žì˜ ëŒ€ê¸°ìž ìˆ˜"ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í”¼ë“œë°±í•˜ì—¬ UXë¥¼ í˜ì‹ í•˜ê³ , ì„œë²„ ì¸ìž…ëŸ‰ì„ ì¡°ì ˆí•˜ëŠ” ì¤‘ì¶”ì  ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
> 
> ### 1. ê°œìš” (Overview)
> ---
>   - ë‹¨ìˆœížˆ Kafkaì— ìš”ì²­ì„ ìŒ“ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‚¬ìš©ìžì˜ ë¶ˆì•ˆê°ì„ í•´ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "ë‚´ ì•žì— 5,000ëª…ì´ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤"ì™€ ê°™ì€ êµ¬ì²´ì ì¸ ì •ë³´ ì œê³µì„ í†µí•´ ì‚¬ìš©ìž ê²½í—˜(UX)ì„ í˜ì‹ í•˜ëŠ” ê²ƒì´ ëª©í‘œìž…ë‹ˆë‹¤.
> 
> ### 2. í•µì‹¬ ë§¤ì»¤ë‹ˆì¦˜: Redis Sorted Set (ZSET)
> ---
>   - Key: `waiting-queue:concert:{concertId}`
>   - Score: `System.currentTimeMillis()` (ì‹œê°„ ê¸°ë°˜ ìžë™ ì •ë ¬)
>   - ìž¥ì : ì´ì§„ íƒìƒ‰ ê¸°ë°˜ì˜ ì•Œê³ ë¦¬ì¦˜($O(\log N)$)ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë°±ë§Œ ëª… ì¤‘ ë‚´ ìˆœìœ„ë¥¼ ì¦‰ì‹œ ì¡°íšŒ ê°€ëŠ¥.
> 
> ### ðŸ› ï¸ 3. ì‹¤ì œ êµ¬í˜„ ì½”ë“œ (WaitingQueueServiceImpl)
> ---
>   ```java
>   @Override
>   public WaitingQueueResponse join(Long userId, Long concertId) {
>       String queueKey = QUEUE_KEY_PREFIX + concertId;
>       String userIdStr = String.valueOf(userId);
>       if (Boolean.TRUE.equals(redisTemplate.hasKey(ACTIVE_KEY_PREFIX + userIdStr))) {
>           return WaitingQueueResponse.builder().userId(userId).concertId(concertId).status("ACTIVE").rank(0L).build();
>       }
>       redisTemplate.opsForZSet().add(queueKey, userIdStr, System.currentTimeMillis());
>       return getStatus(userId, concertId);
>   }
>   ```
> 
> ### ðŸ§ª 4. ê²€ì¦ ê²°ê³¼ ë° íš¨ê³¼ (Results & Impact)
> ---
>   - ì‹¤ì œ ì¶œë ¥ ë¡œê·¸: `[User 101] WAITING (Rank: 1)`, `[User 102] WAITING (Rank: 2)`
>   - ì ìš© íš¨ê³¼: UX í˜ì‹  ë° ë¶ˆí•„ìš”í•œ ìƒˆë¡œê³ ì¹¨ ìž¬ìš”ì²­ ì°¨ë‹¨ìœ¼ë¡œ ì„œë²„ ë¶€í•˜ ê¸‰ê°.

---

## Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling) ðŸ‘ˆ
---
> [!WARNING]
> **ì‹œìŠ¤í…œ ìƒì¡´ ë³´ìž¥**: ìž„ê³„ì¹˜ ì´ìƒì˜ ìš”ì²­ì„ ì‚¬ì „ì— ì°¨ë‹¨í•˜ê³  í™œì„±í™” ì¸ì›ì„ ë™ì ìœ¼ë¡œ ì¡°ì ˆí•˜ëŠ” ìµœì¢… ìˆ˜ë¹„ ë‹¨ê³„ìž…ë‹ˆë‹¤.
> 
> ### 1. í•µì‹¬ ì œì–´ ë§¤ì»¤ë‹ˆì¦˜ (Control Mechanisms)
> ---
>   - **1.1. ì§„ìž… ì°¨ë‹¨ (Throttling)**: ZCARDë¡œ í˜„ìž¬ ëŒ€ê¸° ì¸ì› ì²´í¬, ìž„ê³„ì¹˜ ì´ˆê³¼ ì‹œ ì§„ìž… ê±°ë¶€ ì‘ë‹µ ë°˜í™˜.
>   - **1.2. ìœ ìž…ëŸ‰ ë™ì  ì¡°ì ˆ**: ì„œë²„ ìƒíƒœ(CPU, DB ë¶€í•˜)ì— ë”°ë¼ í™œì„±í™” ì¸ì›ìˆ˜ë¥¼ ê°€ë³€ì ìœ¼ë¡œ ìš´ì˜.
>   - **1.3. ACTIVE í† í° ê²€ì¦**: ì¸í„°ì…‰í„°ë¥¼ êµ¬í˜„í•˜ì—¬ Redisì— `active-user:{id}` í‚¤ê°€ ì¡´ìž¬í•˜ëŠ” ì‚¬ìš©ìžë§Œ ì˜ˆì•½ í—ˆìš©.
> 
> ### ðŸ”„ 2. ìƒíƒœ ì „ì´ë„ (State Transition)
> ---
>   - `WAITING (ZSET)` -> `CHECK_THROTTLE` -> `ACTIVE (String + TTL)` -> `RESERVING (API í˜¸ì¶œ)`