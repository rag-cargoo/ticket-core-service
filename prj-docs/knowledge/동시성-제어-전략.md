# ë™ì‹œì„± ì œì–´ ë° ê³ ì„±ëŠ¥ ëŒ€ê¸°ì—´ ì „ëžµ (Concurrency & Queue Strategy)

> **Purpose**: ì„ ì°©ìˆœ ì¢Œì„ ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ì •í•©ì„± ë¬¸ì œ í•´ê²°ë¶€í„° ì´ˆê³ ì† ëŒ€ê¸°ì—´ ì„¤ê³„ê¹Œì§€ì˜ ê¸°ìˆ ì  ì—¬ì • ê¸°ë¡
> **Date**: 2026-02-07

---

## ðŸ“‚ ëª©ì°¨ (Table of Contents)
- ðŸ’¡ [ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½](#0-ì´ë¡ -ë°°ê²½-ë‚™ê´€ì -ë½-vs-ë¹„ê´€ì -ë½-theory)
- ðŸš€ [Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)](#step-0-ë¬¸ì œ-ìƒí™©-ë½-ë¯¸ì ìš©)
- ðŸš€ [Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)](#step-1-ë‚™ê´€ì -ë½-optimistic-lock)
- ðŸš€ [Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)](#step-2-ë¹„ê´€ì -ë½-pessimistic-lock)
- âš ï¸ [ë½(Lock)ì˜ í•œê³„ì™€ í˜„ì‹¤ì ì¸ ë¬¸ì œ](#-ë½lockì˜-í•œê³„ì™€-í˜„ì‹¤ì ì¸-ë¬¸ì œ)
- ðŸš€ [Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)](#step-3-redis-ë¶„ì‚°-ë½-distributed-lock)
- ðŸš€ [Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue)](#step-4-kafka-ê¸°ë°˜-ë¹„ë™ê¸°-ëŒ€ê¸°ì—´-async-queue)
- ðŸš€ [Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´](#step-5-redis-sorted-set-ê¸°ë°˜-ì‹¤ì‹œê°„-ëŒ€ê¸°ì—´)
- ðŸš€ [Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling)](#step-6-ìœ ìž…ëŸ‰-ì œì–´-ì „ëžµ-throttling)

---

## 0. ì´ë¡  ë°°ê²½: ë‚™ê´€ì  ë½ vs ë¹„ê´€ì  ë½ (Theory)
---
> | íŠ¹ì§• | ë‚™ê´€ì  ë½ (Optimistic Lock) | ë¹„ê´€ì  ë½ (Pessimistic Lock) |
> | :--- | :--- | :--- |
> | **ê¸°ë³¸ ì‚¬ìƒ** | "ì¶©ëŒì€ ë“œë¬¼ ê±°ì•¼. ì¶©ëŒ ë‚˜ë©´ ê·¸ë•Œ í•´ê²°í•˜ìž." | "ì¶©ëŒì€ ë¹ˆë²ˆí•  ê±°ì•¼. ì•„ì˜ˆ ëª» ê±´ë“œë¦¬ê²Œ ë§‰ìž." |
> | **êµ¬í˜„ ë°©ì‹** | **ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§**: ë²„ì „ ì»¬ëŸ¼(`@Version`) ë¹„êµ. | **DB ì¿¼ë¦¬**: `SELECT ... FOR UPDATE`ë¡œ ë¬¼ë¦¬ì  ë½. |
> | **ì„±ëŠ¥ (DB)** | **ë†’ìŒ** (ë½ ëŒ€ê¸° ì—†ìŒ) | **ë‚®ìŒ** (ëŒ€ê¸° ë°œìƒ, ë°ë“œë½ ìœ„í—˜) |
> | **ì¶©ëŒ ì²˜ë¦¬** | ì˜ˆì™¸ ë°œìƒ (`Exception`) -> ë¡¤ë°± -> ìž¬ì‹œë„ í•„ìš” | ëŒ€ê¸° (`Wait`) -> ìˆœì°¨ ì²˜ë¦¬ -> ì„±ê³µ |
> | **ëŒ€í‘œ ì˜ˆì‹œ** | ê²Œì‹œíŒ ìˆ˜ì •, í”„ë¡œí•„ ì—…ë°ì´íŠ¸ | ì„ ì°©ìˆœ ì˜ˆë§¤, ìž¬ê³  ì°¨ê°, ê³„ì¢Œ ì´ì²´ |

---

## Step 0: ë¬¸ì œ ìƒí™© (ë½ ë¯¸ì ìš©)
---
> ### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_1_ë‚™ê´€ì _ë½.java` (JPA @Version ì£¼ì„ ì²˜ë¦¬ í›„ ì‹¤í–‰)
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
>
> ### 2. ìž˜ëª»ëœ êµ¬í˜„ ë°©ì‹ (The Wrong Way)
> - ì•„ë¬´ëŸ° ë³´í˜¸ ìž¥ì¹˜ ì—†ì´ ì¼ë°˜ì ì¸ ì¡°íšŒì™€ ìˆ˜ì •ì„ ë°˜ë³µí•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.
> ```java
> // [Service]
> @Transactional
> public void reserve(Long seatId) {
>     Seat seat = seatRepository.findById(seatId).orElseThrow(); // ëˆ„êµ¬ë‚˜ ë™ì‹œì— ì¡°íšŒ ê°€ëŠ¥
>     seat.reserve(); // ê°ìž ë©”ëª¨ë¦¬ ìƒì—ì„œ ìƒíƒœ ë³€ê²½
>     // ì»¤ë°‹ ì‹œì ì— ë§ˆì§€ë§‰ì— ë“¤ì–´ì˜¨ ìš”ì²­ì´ ë®ì–´ì“°ê±°ë‚˜ ì¤‘ë³µ ìƒì„±ë¨ (Race Condition)
> }
> ```
>
> ### 3. ì‹¤í—˜ ê²°ê³¼ (ì‹¤íŒ¨)
> - ë°ì´í„° ì •í•©ì„±ì´ ì™„ì „ížˆ ê¹¨ì§€ëŠ” í˜„ìƒì´ ë°œìƒí•¨. (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)
>
> #### [ìˆ˜ì¹˜ ê²°ê³¼]
> | í•­ëª© | ê²°ê³¼ê°’ | ë¹„ê³  |
> | :--- | :--- | :--- |
> | **ì„±ê³µ íšŸìˆ˜** | 10ê±´ | **ì¹˜ëª…ì  ì˜¤ë¥˜**: 1ê±´ì´ì–´ì•¼ í•¨ |
> | **ìµœì¢… ì˜ˆì•½ ê±´ìˆ˜** | **10ê±´** | **ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ (Race Condition)** |

---

## Step 1: ë‚™ê´€ì  ë½ (Optimistic Lock)
---
> ### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_1_ë‚™ê´€ì _ë½.java`
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
>
> ### 2. êµ¬í˜„ ë°©ë²• (How to Apply)
> - ì—”í‹°í‹°ì— `@Version` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì˜ ì²´í¬ ë¡œì§ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
> ```java
> // [Entity]
> @Version // JPAê°€ ì œê³µí•˜ëŠ” ë‚™ê´€ì  ë½ ë©”ì»¤ë‹ˆì¦˜
> private Long version;
> ```
>
> ### 3. ë™ìž‘ ì›ë¦¬ ë° SQL
> - ìˆ˜ì • ì¿¼ë¦¬ ì‹œì ì— ìžë™ìœ¼ë¡œ ë²„ì „ ì²´í¬ ì¡°ê±´ì´ ë¶™ìŠµë‹ˆë‹¤.
> ```sql
> update seats 
> set status='RESERVED', version=1 
> where id=1 and version=0; -- ì²˜ìŒ ì½ì€ ë²„ì „ì´ 0ì¼ ë•Œë§Œ ì„±ê³µ
> ```
>
> ### 4. ì‹¤í—˜ ê²°ê³¼ ë° ë¶„ì„
> - **ì„±ê³µ íšŸìˆ˜**: 1ê±´
> - **ì‹¤íŒ¨ íšŸìˆ˜**: 29ê±´ (ObjectOptimisticLockingFailureException ë°œìƒ)
> - **ê²°ë¡ **: ë°ì´í„° ì •í•©ì„±ì€ ë³´ìž¥í•˜ë‚˜, ì¶©ëŒ ì‹œ ì‚¬ìš©ìžì—ê²Œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ ì„ ì°©ìˆœ ì˜ˆë§¤ì—ëŠ” í•œê³„ê°€ ìžˆìŒ.

---

## Step 2: ë¹„ê´€ì  ë½ (Pessimistic Lock)
---
> ### 1. ì‹¤í—˜ ì‹œë‚˜ë¦¬ì˜¤ (Experimental Scenario)
> - **í…ŒìŠ¤íŠ¸ ì½”ë“œ**: `ë™ì‹œì„±_í…ŒìŠ¤íŠ¸_2_ë¹„ê´€ì _ë½.java`
> - **ëŒ€ìƒ**: 1ê°œ ì¢Œì„ (Seat ID: 1)
> - **ë¶€í•˜**: 30ëª…ì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì˜ˆì•½ API í˜¸ì¶œ
>
> ### 2. êµ¬í˜„ ë°©ë²• (How to Apply)
> - Spring Data JPAì—ì„œ ë¹„ê´€ì  ë½ì„ ê±°ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ ê°€ì§€ê°€ ìžˆìŠµë‹ˆë‹¤.
>
> #### ë°©ë²• A: @Lock ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš© (ê¶Œìž¥)
> - JPAê°€ ì œê³µí•˜ëŠ” `@Lock` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ ìƒì„± ì‹œì ì— ë½ ëª¨ë“œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ì´ ë°©ì‹ì„ ì“°ë©´ JPAê°€ SQL ëì— ìžë™ìœ¼ë¡œ `FOR UPDATE`ë¥¼ ì¶”ê°€í•´ ì¤ë‹ˆë‹¤.
> ```java
> // [Repository]
> public interface SeatRepository extends JpaRepository<Seat, Long> {
>     @Lock(LockModeType.PESSIMISTIC_WRITE) // í•µì‹¬: ë¹„ê´€ì  ë½ ëª¨ë“œ ì§€ì •
>     @Query("SELECT s FROM Seat s WHERE s.id = :id")
>     Optional<Seat> findByIdWithPessimisticLock(@Param("id") Long id);
> }
> ```
>
> ### 3. ë™ìž‘ ì›ë¦¬ ë° SQL
> - ë°ì´í„°ë¥¼ ì½ëŠ” ì‹œì ë¶€í„° DBê°€ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì˜ ì ‘ê·¼ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
> ```sql
> /* ë°©ë²• A ì ìš© ì‹œ ì‹¤í–‰ë˜ëŠ” ì‹¤ì œ SQL */
> select s1_0.id, ... from seats s1_0 where s1_0.id=? for update; -- DB ì—”ì§„ì´ í•´ë‹¹ í–‰(Row)ì„ ê½‰ ìž¡ìŒ (ìžë¬¼ì‡ )
> ```
>
> ### 4. ê²°ë¡  (Conclusion)
> - **ë¹„ê´€ì  ë½ì€ ì¿¼ë¦¬ë¡œ í•´ê²°í•œë‹¤**: ì½”ë“œ ë¡œì§ì´ ì•„ë‹ˆë¼ DB ì—”ì§„ì˜ íž˜ì„ ë¹Œë ¤ **ì¤„ì„ ì„¸ìš°ëŠ” ë°©ì‹**ì´ë‹¤.
> - **ìž¥ì **: ë‚™ê´€ì  ë½ë³´ë‹¤ ì •í•©ì„±ì´ ê°•ë ¥í•˜ê³ , ë¶ˆí•„ìš”í•œ ì˜ˆì™¸ ìž¬ì‹œë„ ë¡œì§ì´ í•„ìš” ì—†ë‹¤.
> - **ë‹¨ì **: ëŒ€ê¸° ì‹œê°„ì´ ê¸¸ì–´ì§€ë©´ DB ì „ì²´ ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤€ë‹¤.

---

## ðŸš¨ ë½(Lock)ë§Œìœ¼ë¡œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” í˜„ì‹¤ì ì¸ ë¬¸ì œ
---
> ### 1. ì‚¬ìš©ìž ê²½í—˜(UX)ì˜ íŒŒê´´: "ë§Œ ëª… ì¤‘ í•œ ëª…ë§Œ ì„±ê³µ"
> - í˜„ìž¬ ë°©ì‹ì€ 1ëª…ì´ ë½ì„ ìž¡ê³  ìžˆëŠ” ë™ì•ˆ ë‚˜ë¨¸ì§€ëŠ” ëŒ€ê¸°í•˜ê±°ë‚˜ ì—ëŸ¬ë¥¼ ë°›ëŠ”ë‹¤.
> - ë§Œ ëª…ì˜ ì‚¬ìš©ìž ì¤‘ 9,999ëª…ì€ "ì´ë¯¸ ì˜ˆì•½ëœ ì¢Œì„ìž…ë‹ˆë‹¤"ë¼ëŠ” ë¬´ëšëší•œ ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ ë°›ê³  ë‹¤ì‹œ ê´‘í´ì„ ì‹œë„í•´ì•¼ í•œë‹¤. (ê´‘í´ ì „ìŸ ìœ ë°œ)
>
> ### 2. ì„œë²„ ìžì› ê³ ê°ˆ: "DB ì»¤ë„¥ì…˜ í’€ ë§ˆë¹„"
> - ë¹„ê´€ì  ë½(`FOR UPDATE`)ì€ DB ì»¤ë„¥ì…˜ì„ ì ìœ í•œ ì±„ë¡œ ëŒ€ê¸°í•œë‹¤.
> - ë™ì‹œ ìš”ì²­ì´ ë§Žì•„ì§€ë©´ ëª¨ë“  ì»¤ë„¥ì…˜ì´ ë½ ëŒ€ê¸°ì— ë¹ ì§€ê²Œ ë˜ì–´, ì˜ˆì•½ê³¼ ìƒê´€ì—†ëŠ” ë‹¤ë¥¸ API(ê³µì—° ì¡°íšŒ ë“±)ê¹Œì§€ ëª¨ë‘ ë¨¹í†µì´ ë˜ëŠ” **'ì„œë²„ ë§ˆë¹„'** ìƒíƒœì— ì´ë¥¸ë‹¤.
>
> ### ðŸ’¡ í•´ê²°ì˜ ë°©í–¥: Redis ë¶„ì‚° ë½ê³¼ ëŒ€ê¸°ì—´
> - **ì²´ë ¥ ê°•í™” (Step 3)**: DBë³´ë‹¤ í›¨ì”¬ ê°€ë³ê³  ë¹ ë¥¸ **Redis**ì—ì„œ ë½ì„ ì²˜ë¦¬í•˜ì—¬ DB ë¶€í•˜ë¥¼ ì›ì²œ ì°¨ë‹¨í•œë‹¤.
> - **ì§ˆì„œ í™•ë¦½ (Phase 3)**: ë‹¨ìˆœížˆ ì‹¤íŒ¨ì‹œí‚¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ëŒ€ê¸°ì—´(Queue)**ì„ ë„ìž…í•˜ì—¬ ì‚¬ìš©ìžì—ê²Œ ëŒ€ê¸° ìˆœë²ˆì„ ë¶€ì—¬í•˜ê³  ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” UXë¥¼ ì œê³µí•œë‹¤.

---

## Step 3: Redis ë¶„ì‚° ë½ (Distributed Lock)
---
> ### ðŸ§ª Step 3-1: ì²« ë²ˆì§¸ ì‹œë„ (ì‹¤íŒ¨ ì‚¬ë¡€ - 30/30 ì„±ê³µ) âŒ
> - **ì‹¤í—˜ ê²°ê³¼**: **30ëª… ì „ì› ì˜ˆì•½ ì„±ê³µ (ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ)**
> - **ì›ì¸ ë¶„ì„**: Redis ë½ì€ ë¡œì§ì´ ëë‚˜ìžë§ˆìž í•´ì œë˜ì§€ë§Œ, `@Transactional`ì— ì˜í•œ DB ì»¤ë°‹ì€ ê·¸ ì´í›„ì— ë°œìƒí•¨. Thread Aê°€ ë½ì„ í•´ì œí•˜ëŠ” ìˆœê°„ ì•„ì§ DBì—ëŠ” ë°ì´í„°ê°€ ë°˜ì˜ë˜ì§€ ì•Šì•„ Thread Bê°€ ë“¤ì–´ì™€ì„œ ì‚¬ê³  ë°œìƒ.
> - **êµí›ˆ**: "ë¶„ì‚° ë½ì˜ í•´ì œ ì‹œì ì€ ë°˜ë“œì‹œ íŠ¸ëžœìž­ì…˜ì˜ ì»¤ë°‹ ì‹œì ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•œë‹¤."
>
> ### âœ… Step 3-2: ë‘ ë²ˆì§¸ ì‹œë„ (ì„±ê³µ ì‚¬ë¡€ - Facade íŒ¨í„´ ë„ìž…)
> - **í•´ê²° ì „ëžµ**: ë³„ë„ì˜ Facade í´ëž˜ìŠ¤ë¥¼ ë‘ì–´ ë½ì„ ìž¡ê³ , ê·¸ ì•ˆì—ì„œ íŠ¸ëžœìž­ì…˜ ì„œë¹„ìŠ¤(`reservationService.createReservation`)ë¥¼ í˜¸ì¶œí•˜ì—¬ DB ì €ìž¥ì´ ì™„ë²½ížˆ ëë‚œ ë’¤ì— ë½ì„ í’€ë„ë¡ ì„¤ê³„.
>
> ### ðŸŒŸ [Special] Magic Numberë¥¼ ë°°ì œí•œ ìžìœ¨ì  ì‹œìŠ¤í…œ ì„¤ê³„ (ì¤‘ìš”)
> - **ì§ìž‘í•˜ëŠ” ìˆ«ìžì˜ ìœ„í—˜ì„±**: `lock.tryLock(10, 2, TimeUnit.SECONDS)`ì—ì„œ `2ì´ˆ`ë¼ëŠ” ìˆ«ìžëŠ” ê°œë°œìžì˜ ì§ìž‘ì— ë¶ˆê³¼í•¨. DBê°€ ëŠë ¤ì ¸ 2.1ì´ˆê°€ ê±¸ë¦¬ë©´ ì •í•©ì„± íŒŒê´´ë¨.
> - **ìžìœ¨ì  í•´ê²°ì±…: Redisson Watchdog (ê°ì‹œê²¬) ðŸ•**: `leaseTime`ì„ `-1`ë¡œ ì„¤ì •í•˜ì—¬ Redissonì´ ì£¼ê¸°ì ìœ¼ë¡œ ë½ì˜ ìœ íš¨ì‹œê°„ì„ ì—°ìž¥í•˜ê²Œ í•¨. ë¡œì§ì´ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë“  ìƒí™©ì— ë§žì¶° ë½ ìœ ì§€ ì‹œê°„ì„ ìŠ¤ìŠ¤ë¡œ ì¡°ì ˆí•¨.
> - **ðŸ’¡ í•µì‹¬ êµí›ˆ**: "ì„¤ì •ê°’ì€ ìµœì†Œí™”í•˜ê³ , ìžìœ¨ì ì¸ ë©”ì»¤ë‹ˆì¦˜(Watchdog ë“±)ì„ ìš°ì„ ì‹œí•˜ëŠ” ì„¤ê³„ê°€ ëŒ€ê·œëª¨ ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì‚´ì•„ë‚¨ëŠ” í”„ë¡œê·¸ëž˜ë° ë°©ì‹ì´ë‹¤."
>
> ### ðŸ› ï¸ í•´ê²° ì „ëžµ: RedissonLockFacade ì „ì²´ ì½”ë“œ
> ```java
> @Component
> @RequiredArgsConstructor
> public class RedissonLockFacade {
>     private final RedissonClient redissonClient;
>     private final ReservationService reservationService;
>     public ReservationResponse createReservation(ReservationRequest request) {
>         String lockKey = "lock:seat:" + request.seatId();
>         RLock lock = redissonClient.getLock(lockKey);
>         try {
>             boolean available = lock.tryLock(10, -1, TimeUnit.SECONDS); // Watchdog í™œì„±í™”
>             if (!available) throw new RuntimeException("ë½ íšë“ ì‹¤íŒ¨");
>             return reservationService.createReservation(request);
>         } catch (InterruptedException e) {
>             Thread.currentThread().interrupt();
>             throw new RuntimeException(e);
>         } finally {
>             if (lock.isHeldByCurrentThread()) lock.unlock();
>         }
>     }
> }
> ```

---

## Step 4: Kafka ê¸°ë°˜ ë¹„ë™ê¸° ëŒ€ê¸°ì—´ (Async Queue) âœ…
---
> ### ðŸ’¡ 1. ì™œ 'ëŒ€ê¸°ì—´' ë°©ì‹ì¸ê°€? (The Paradigm Shift)
> - **Before (Blocking)**: í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­ì„ ë³´ë‚´ë©´ DB ì˜ˆì•½ì´ ëë‚  ë•Œê¹Œì§€ ìŠ¤ë ˆë“œê°€ ëŒ€ê¸°(Block)í•¨.
> - **After (Event-Driven)**: í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì„ ì¦‰ì‹œ Kafkaì— ë‹´ê³  ì‘ë‹µ(Accepted). ì‹¤ì œ ì²˜ë¦¬ëŠ” ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ì†ë„ë¡œ ë‚˜ì¤‘ì— ìˆ˜í–‰.
>
> ### ðŸ› ï¸ 2. êµ¬í˜„ ë°©ë²• (How to Apply)
> - **2.1. ìš”ì²­ ìˆ˜ì§‘ (Producer)**: ì‚¬ìš©ìžì˜ ìš”ì²­ì„ ì´ë²¤íŠ¸ë¡œ ê°ì‹¸ Kafkaë¡œ ì „ì†¡. ì´ë•Œ `seatId`ë¥¼ ë©”ì‹œì§€ í‚¤(Key)ë¡œ ì‚¬ìš©í•˜ì—¬ ë™ì¼ ì¢Œì„ ìš”ì²­ì˜ ìˆœì„œ ë³´ìž¥.
> - **2.2. ë¹„ë™ê¸° ì²˜ë¦¬ (Consumer)**: `@KafkaListener`ë¥¼ í†µí•´ ë©”ì‹œì§€ë¥¼ êº¼ë‚´ì–´ ì‹¤ì œ ì˜ˆì•½ ì„œë¹„ìŠ¤ í˜¸ì¶œ.
> - **2.3. ì‹¤ì‹œê°„ ê²°ê³¼ í†µë³´ (SSE)**: ì‚¬ìš©ìžê°€ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šë„ë¡ ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ë°ì´í„°ë¥¼ ë°€ì–´ì£¼ëŠ” SSE ì ìš©.
>
> ### âœ… 3. ì½”ë“œ ë³€í™˜ ëŒ€ì¡° (Sync to Async Migration)
> - **Before**: `ResponseEntity.ok(reservationService.createReservation(request))`
> - **After**: `queueService.setStatus(...)`, `kafkaProducer.send(...)`, `return ResponseEntity.accepted()`
>
> ### ðŸ’¡ 4. í•µì‹¬ ì„¤ê³„ ê²°ì • ë° ì •í•©ì„± ë³´ìž¥ (ADR)
> | ê²°ì • ì‚¬í•­ | ì„¤ê³„ ë‚´ìš© | ê³µí•™ì  ì´ìœ  |
> | :--- | :--- | :--- |
> | **Partition Key** | `seatId` | ë™ì¼ ì¢Œì„ ê²½í•©ì„ ë‹¨ì¼ ì»¨ìŠˆë¨¸ ìŠ¤ë ˆë“œì—ì„œ ìˆœì°¨ ì²˜ë¦¬ (ë¬¼ë¦¬ì  ìˆœì„œ ë³´ìž¥) |
> | **Status Store** | Redis | ë¹„ë™ê¸° ì²˜ë¦¬ ì¤‘ ì‚¬ìš©ìžê°€ ì–¸ì œë“  ìƒíƒœë¥¼ ì¡°íšŒ(`Polling`)í•  ìˆ˜ ìžˆëŠ” ì´ˆê³ ì† ì €ìž¥ì†Œ |
> | **Notification** | SSE | í´ë§ì— ì˜í•œ íŠ¸ëž˜í”½ì„ ì¤„ì´ê³  ì‚¬ìš©ìžì—ê²Œ ì¦‰ê°ì ì¸ ë‹¹ì²¨ ê²½í—˜ ì œê³µ |

---

## Step 5: Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì—´ âœ…
---
> ### ðŸ’¡ 1. ê°œìš” (Overview)
> - ë‹¨ìˆœížˆ Kafkaì— ìš”ì²­ì„ ìŒ“ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ì‚¬ìš©ìžì˜ ë¶ˆì•ˆê°ì„ í•´ì†Œí•  ìˆ˜ ì—†ìŒ. "ë‚´ ì•žì— 5,000ëª…ì´ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤"ì™€ ê°™ì€ ì‹¤ì‹œê°„ ìˆœë²ˆ ì œê³µì´ ëª©í‘œ.
>
> ### ðŸ’¡ 2. í•µì‹¬ ë§¤ì»¤ë‹ˆì¦˜: Redis Sorted Set (ZSET)
> - **Key**: `waiting-queue:concert:{id}`
> - **Member**: `userId`
> - **Score**: `System.currentTimeMillis()` (ë„ì°© ì‹œê°„ ê¸°ë°˜ ìžë™ ì •ë ¬)
>
> ### ðŸ› ï¸ 3. Redis Z-ëª…ë ¹ì–´ ìƒì„¸ ë° Java êµ¬í˜„ (Deep Dive)
> | ëª…ë ¹ì–´ | ì„¤ëª… | Java í™œìš© ì˜ˆì‹œ |
> | :--- | :--- | :--- |
> | **ZADD** | ëŒ€ê¸°ì—´ ì§„ìž… | `opsForZSet().add(key, userId, score)` |
> | **ZRANK** | ë‚´ ìˆœìœ„ ì¡°íšŒ (0ë²ˆë¶€í„° ì‹œìž‘) | `opsForZSet().rank(key, userId)` |
> | **ZRANGE** | íŠ¹ì • ë²”ìœ„ ëŒ€ê¸°ìž ì¶”ì¶œ | `opsForZSet().range(key, start, stop)` |
> | **ZREM** | ëŒ€ê¸°ì—´ì—ì„œ ì œê±° (ìž…ìž¥ ì²˜ë¦¬) | `opsForZSet().remove(key, userId)` |
> | **ZCARD** | í˜„ìž¬ ëŒ€ê¸°ìž ì´ ì¸ì›ìˆ˜ | `opsForZSet().size(key)` |

---

## Step 6: ìœ ìž…ëŸ‰ ì œì–´ ì „ëžµ (Throttling) ðŸ‘ˆ
---
> ### ðŸ’¡ 1. ê°œìš” (Overview)
> - ëŒ€ê¸°ì—´ì˜ ì™„ì„±ì€ ë‹¨ìˆœížˆ ì¤„ì„ ì„¸ìš°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, **ì„œë²„ê°€ ê°ë‹¹ ê°€ëŠ¥í•œ ë§Œí¼ë§Œ ë“¤ì—¬ë³´ë‚´ëŠ” ê²ƒ**ìž…ë‹ˆë‹¤.
>
> ### ðŸ› ï¸ 2. í•µì‹¬ ì œì–´ ë§¤ì»¤ë‹ˆì¦˜ (Control Mechanisms)
> - **2.1. ì§„ìž… ì°¨ë‹¨ (Throttling)**: `ZCARD`ë¡œ í˜„ìž¬ ëŒ€ê¸° ì¸ì›ì„ ì²´í¬í•˜ì—¬ ìž„ê³„ì¹˜(ì˜ˆ: 50,000ëª…) ì´ˆê³¼ ì‹œ ì§„ìž… ê±°ë¶€ (ìž…êµ¬ ì»·).
> - **2.2. ìœ ìž…ëŸ‰ ë™ì  ì¡°ì ˆ (Dynamic Batching)**: ìŠ¤ì¼€ì¤„ëŸ¬ê°€ í™œì„±í™”í•˜ëŠ” ì¸ì›(`activateCount`)ì„ ê³ ì •ê°’ì´ ì•„ë‹Œ ì„œë²„ ìƒíƒœì— ë”°ë¼ ê°€ë³€ì ìœ¼ë¡œ ìš´ì˜ (ìˆ˜ë„ê¼­ì§€).
> - **2.3. ACTIVE í† í° ê²€ì¦ (Security)**: ì¸í„°ì…‰í„°ë¥¼ êµ¬í˜„í•˜ì—¬ Redisì— `active-user:{id}` í‚¤ê°€ ì¡´ìž¬í•˜ëŠ” ì‚¬ìš©ìžë§Œ ì˜ˆì•½ API í˜¸ì¶œ í—ˆìš© (ì•”í–‰ì–´ì‚¬).
>
> ### ðŸ”„ 3. ìƒíƒœ ì „ì´ë„ (State Transition)
> - `WAITING (ZSET)` -> `CHECK_THROTTLE` -> `ACTIVE (String + TTL)` -> `RESERVING (API í˜¸ì¶œ)`
---
