# 대기열 유입량 제어 전략 (Throttling Strategy)

> **Purpose**: 시스템 부하에 따른 대기열 진입 제한(Throttling) 및 활성 유저 유입량 동적 조절 설계
> **Date**: 2026-02-07

## 1. 개요 (Overview)
대기열 시스템의 완성은 단순히 줄을 세우는 것이 아니라, **서버가 감당 가능한 만큼만 들여보내는 것**입니다. 이를 위해 두 가지 제어 장치를 도입합니다.

---

## 2. 핵심 제어 매커니즘 (Control Mechanisms)

### 2.1. 진입 차단 (Throttling) - "입구 컷"
- **목적**: 대기열 자체가 너무 길어져 Redis 메모리가 고갈되거나, 대기 시간이 수 시간을 넘어가 의미가 없어지는 상황 방지.
- **로직**: `ZCARD` 명령어로 현재 대기 인원을 체크하여 임계치(Threshold) 초과 시 진입 거부.
- **기준**: `MAX_QUEUE_SIZE = 50,000` (설정 가능)

### 2.2. 유입량 동적 조절 (Dynamic Batching) - "수도꼭지"
- **목적**: 서버 상태가 좋을 때는 많이, 나쁠 때는 적게 통과시킴.
- **로직**: 스케줄러가 활성화하는 인원(`activateCount`)을 고정값이 아닌 변수로 관리.
- **고도화 방향**: CPU 점유율, DB 커넥션 풀 잔여량 등과 연동 (우선은 관리자 설정값 기반으로 시작).

### 2.3. ACTIVE 토큰 검증 (Security) - "암행어사"
- **목적**: 대기열을 우회하여 직접 예약 API를 호출하는 어뷰징 차단.
- **로직**: `ActiveUserInterceptor`를 구현하여, 예약 API 호출 시 Redis에 `active-user:{id}` 키가 존재하는지 확인.

---

## 3. 상태 전이도 (State Transition)

1.  **WAITING**: ZSET에 점수와 함께 등록됨.
2.  **CHECK_THROTTLE**: 진입 전 `ZCARD`로 현재 대기열 크기 확인.
3.  **ACTIVE**: 스케줄러에 의해 ZSET에서 제거되고 String 키(TTL 5분)로 복사됨.
4.  **RESERVING**: 실제 예약 API 호출 (Interceptor에서 ACTIVE 여부 검증).

---

## 4. 구현 계획 (Implementation)
- [ ] `WaitingQueueService`에 `ZCARD` 기반 진입 제한 로직 추가.
- [ ] `ActiveUserInterceptor` 구현 및 `WebMvcConfigurer` 등록.
- [ ] `ReservationController`의 특정 메서드에 권한 체크 적용.
