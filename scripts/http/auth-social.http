@host = http://localhost:8080
@ts = {{$timestamp}}
@naverState = naver-state-{{ts}}
@kakaoCode = CHANGE_ME_KAKAO_AUTH_CODE
@naverCode = CHANGE_ME_NAVER_AUTH_CODE

### 1) 테스트 공연/좌석 셋업 (v7 hold용 seat 준비)
POST {{host}}/api/concerts/setup
Content-Type: application/json

{
  "title": "Auth-Social-{{ts}}",
  "artistName": "Auth-Artist-{{ts}}",
  "agencyName": "Auth-Agency-{{ts}}",
  "concertDate": "2026-06-01T18:00:00",
  "seatCount": 50
}
> {%
const body = typeof response.body === "string" ? response.body : String(response.body);
const concertMatch = body.match(/ConcertID=(\d+)/);
const optionMatch = body.match(/OptionID=(\d+)/);
if (concertMatch) client.global.set("authConcertId", concertMatch[1]);
if (optionMatch) client.global.set("authOptionId", optionMatch[1]);
%}

### 2) 좌석 조회 및 authSeatId 저장
GET {{host}}/api/concerts/options/{{authOptionId}}/seats
> {%
if (Array.isArray(response.body) && response.body.length > 0) {
  client.global.set("authSeatId", String(response.body[0].id));
}
%}

### 3) 카카오 인가 URL 조회
GET {{host}}/api/auth/social/kakao/authorize-url

### 4) 네이버 인가 URL 조회 (state 지정)
GET {{host}}/api/auth/social/naver/authorize-url?state={{naverState}}

### 5) 카카오 code 교환 (수동 code 입력 필요)
POST {{host}}/api/auth/social/kakao/exchange
Content-Type: application/json

{
  "code": "{{kakaoCode}}",
  "state": "dev-state-{{ts}}"
}
> {%
if (response.status === 200 && response.body) {
  client.global.set("accessToken", response.body.accessToken);
  client.global.set("refreshToken", response.body.refreshToken);
}
%}

### 6) 네이버 code 교환 (수동 code 입력 필요)
POST {{host}}/api/auth/social/naver/exchange
Content-Type: application/json

{
  "code": "{{naverCode}}",
  "state": "{{naverState}}"
}
> {%
if (response.status === 200 && response.body) {
  client.global.set("accessToken", response.body.accessToken);
  client.global.set("refreshToken", response.body.refreshToken);
}
%}

### 7) Access/Refresh 토큰 재발급 (A2)
POST {{host}}/api/auth/token/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}
> {%
if (response.status === 200 && response.body) {
  client.global.set("accessToken", response.body.accessToken);
  client.global.set("refreshToken", response.body.refreshToken);
}
%}

### 8) 내 인증 프로필 조회 (A2)
GET {{host}}/api/auth/me
Authorization: Bearer {{accessToken}}

### 9) 인증 사용자 기반 HOLD 생성 (A2, v7)
POST {{host}}/api/reservations/v7/holds
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "seatId": {{authSeatId}},
  "requestFingerprint": "fp-http-sample-{{ts}}",
  "deviceFingerprint": "device-http-sample-{{ts}}"
}

### 10) Provider callback -> U1 callback redirect 확인
GET {{host}}/login/oauth2/code/naver?code=sample-code&state={{naverState}}

### 11) 로그아웃
POST {{host}}/api/auth/logout
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

### 12) 로그아웃 이후 access 재사용 차단 확인 (401 예상)
GET {{host}}/api/auth/me
Authorization: Bearer {{accessToken}}
> {%
client.test("logout blocks access token reuse", function() {
  client.assert(response.status === 401, "expected 401");
});
%}

### 13) 로그아웃 이후 refresh 재사용 차단 확인 (400 예상)
POST {{host}}/api/auth/token/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}
> {%
client.test("logout blocks refresh token reuse", function() {
  client.assert(response.status === 400, "expected 400");
});
%}
